<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Music Streaming</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Video.js for unified audio/video playback -->
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet">
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
            background-attachment: fixed;
            height: 100%;
            color: #fff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Animated gradient background */
        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Floating particles effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                radial-gradient(circle at 20% 30%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(255, 255, 255, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* Watermark Sphere with Headphones */
        .watermark-sphere {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            pointer-events: none;
            z-index: 1;
            opacity: 0.41;
            animation: breathingEffect 6s ease-in-out infinite;
        }

        @keyframes breathingEffect {

            0%,
            100% {
                transform: translate(-50%, -50%) scale(1);
            }

            50% {
                transform: translate(-50%, -50%) scale(1.15);
            }
        }

        .sphere-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* Fixed Headphones Icon (Behind Sphere) */
        .headphones-icon {
            position: absolute;
            top: 34%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 260px;
            color: rgba(255, 255, 255, 0.3);
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            z-index: 1;
        }

        /* Rotating Sphere (Earth-like) - Front Layer */
        .sphere {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.94) 50%, rgba(255, 255, 255, 0.03));
            box-shadow:
                inset -15px -15px 30px rgba(0, 0, 0, 0.2),
                inset 15px 15px 30px rgba(255, 255, 255, 0.15),
                0 0 25px rgba(255, 255, 255, 0.2),
                0 0 50px rgba(255, 255, 255, 0.15);
            position: relative;
            overflow: hidden;
            z-index: 2;
        }

        /* Sphere texture lines (rotating left to right) */
        .sphere::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 300%;
            height: 100%;
            background: repeating-linear-gradient(90deg,
                    transparent,
                    transparent 12px,
                    rgba(255, 255, 255, 0.08) 12px,
                    rgba(255, 255, 255, 0.08) 14px);
            animation: sphereTexture 20s linear infinite;
        }

        /* Horizontal latitude lines */
        .sphere::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(0deg,
                    transparent,
                    transparent 18px,
                    rgba(255, 255, 255, 0.05) 18px,
                    rgba(255, 255, 255, 0.05) 20px);
            border-radius: 50%;
        }

        @keyframes sphereRotateY {
            0% {
                transform: translate(-50%, -50%) rotateY(0deg);
            }

            100% {
                transform: translate(-50%, -50%) rotateY(360deg);
            }
        }

        @keyframes sphereTexture {
            0% {
                left: -100%;
            }

            100% {
                left: 0%;
            }
        }

        @keyframes sphereGlow {

            0%,
            100% {
                box-shadow:
                    inset -15px -15px 30px rgba(0, 0, 0, 0.2),
                    inset 15px 15px 30px rgba(255, 255, 255, 0.15),
                    0 0 25px rgba(255, 255, 255, 0.25),
                    0 0 50px rgba(255, 255, 255, 0.2);
            }

            50% {
                box-shadow:
                    inset -15px -15px 30px rgba(0, 0, 0, 0.2),
                    inset 15px 15px 30px rgba(255, 255, 255, 0.2),
                    0 0 35px rgba(255, 255, 255, 0.4),
                    0 0 70px rgba(255, 255, 255, 0.3);
            }
        }

        /* Responsive watermark */
        @media (max-width: 1024px) {
            .watermark-sphere {
                width: 240px;
                height: 240px;
            }

            .sphere {
                width: 150px;
                height: 150px;
            }

            .headphones-icon {
                font-size: 260px;
            }
        }

        @media (max-width: 768px) {
            .watermark-sphere {
                width: 200px;
                height: 200px;
            }

            .sphere {
                width: 120px;
                height: 120px;
            }

            .headphones-icon {
                font-size: 165px;
            }
        }

        /* Thin Scrollbar Styles */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
        }

        *::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        *::-webkit-scrollbar-track {
            background: transparent;
        }

        *::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }

        *::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Header - Sticky at top */
        .header {
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(30px) saturate(120%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding: 12px 20px;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.2);
            position: relative;
        }

        /* Logo */
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            text-decoration: none;
            position: relative;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.2));
            border-radius: 50%;
            font-size: 1.4rem;
            animation: logoGlow 4s ease-in-out infinite;
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.5),
                0 0 50px rgba(255, 255, 255, 0.3);
            position: relative;
        }

        @keyframes logoGlow {

            0%,
            100% {
                box-shadow: 0 0 25px rgba(255, 255, 255, 0.5),
                    0 0 50px rgba(255, 255, 255, 0.3),
                    0 0 75px rgba(255, 255, 255, 0.2),
                    inset 0 0 20px rgba(255, 255, 255, 0.3);
                transform: scale(1);
            }

            50% {
                box-shadow: 0 0 40px rgba(255, 255, 255, 0.8),
                    0 0 80px rgba(255, 255, 255, 0.6),
                    0 0 120px rgba(255, 255, 255, 0.4),
                    inset 0 0 30px rgba(255, 255, 255, 0.5);
                transform: scale(1.08);
            }
        }

        .logo-icon i {
            animation: iconPulse 4s ease-in-out infinite;
        }

        @keyframes iconPulse {

            0%,
            100% {
                opacity: 0.9;
            }

            50% {
                opacity: 1;
            }
        }

        .logo-text {
            font-size: 1.3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, rgba(255, 255, 255, 0.8));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.5px;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            justify-content: flex-end;
        }

        /* Main Container */
        .container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            padding-bottom: 160px;
            /* Space for fixed player */
            min-height: 0;
        }

        .content-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            height: 100%;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tab {
            background: rgba(255, 255, 255, 0);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            padding: 10px 22px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.9rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .tab:hover::before {
            left: 100%;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.28);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .tab.active {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.3));
            color: #fff;
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }

        .tab i {
            font-size: 0.85rem;
        }

        /* Content */
        .content {
            display: none;
        }

        .content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Glassmorphism Effect */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        /* Search Bar */
        .search-container {
            background: rgba(255, 255, 255, 0);
            backdrop-filter: blur(20px) saturate(180%);
            border-radius: 50px;
            padding: 6px 22px;
            border: 1px solid rgba(255, 255, 255, 0.30);
            display: flex;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(31, 38, 135, 0.1);
            flex: 1;
            max-width: 500px;
            min-width: 200px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .search-container:focus-within {
            background: rgba(255, 255, 255, 0.28);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 6px 25px rgba(31, 38, 135, 0.2);
            transform: translateY(-2px);
        }

        .search-container input {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 0.95rem;
            outline: none;
            min-width: 0;
            font-weight: 400;
        }

        .search-container input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .search-container button {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 10px 22px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            font-size: 0.85rem;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .search-container button:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.3));
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .search-container button:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(1.02);
        }

        .search-container button i {
            font-size: 0.85rem;
        }

        /* Settings Icon */
        .settings-icon {
            background: rgba(255, 255, 255, 0);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.30);
            border-radius: 50%;
            width: 46px;
            height: 46px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            color: #fff;
            font-size: 1.15rem;
            box-shadow: 0 4px 15px rgba(31, 38, 135, 0.1);
            position: relative;
            overflow: hidden;
        }

        .settings-icon::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }

        .settings-icon:hover::before {
            width: 100px;
            height: 100px;
        }

        .settings-icon:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(180deg) scale(1.1);
            box-shadow: 0 6px 25px rgba(31, 38, 135, 0.2);
        }

        /* Dialog Overlay */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0);
            backdrop-filter: blur(0px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                visibility 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                background 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                backdrop-filter 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dialog-overlay.active {
            opacity: 1;
            visibility: visible;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        /* Dialog Container */
        .dialog {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 20px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.8) translateY(-30px);
            opacity: 0;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
                opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dialog-overlay.active .dialog {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        /* Dialog Header */
        .dialog-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .dialog-header h2 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dialog-header h2 i {
            color: rgba(255, 255, 255, 0.8);
        }

        .dialog-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 1.1rem;
        }

        .dialog-close:hover {
            background: rgba(255, 100, 100, 0.3);
            transform: rotate(90deg);
        }

        /* Dialog Body */
        .dialog-body {
            padding: 24px;
            max-height: calc(80vh - 80px);
            overflow-y: auto;
        }

        /* Settings Section */
        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section:last-child {
            margin-bottom: 0;
        }

        .settings-section h3 {
            font-size: 0.9rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .settings-option {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .settings-option:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .settings-option:last-child {
            margin-bottom: 0;
        }

        .settings-option-label {
            font-size: 0.95rem;
            font-weight: 500;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-option-label i {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .settings-option-description {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 12px;
        }

        /* View Toggle in Settings */
        .view-toggle {
            display: flex;
            gap: 8px;
        }

        .view-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.25);
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
        }

        .view-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .view-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: rgba(255, 255, 255, 0.3);
            color: #fff;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .view-btn i {
            font-size: 1rem;
        }

        /* List View */
        .songs-list {
            display: none;
        }

        .songs-list.active {
            display: block;
        }

        .song-item {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
        }

        .song-item:hover {
            background: rgba(255, 255, 255, 0.18);
            transform: translateX(4px);
        }

        .song-item img {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
        }

        .song-item-info {
            flex: 1;
            min-width: 0;
        }

        .song-item-title {
            font-size: 0.95rem;
            font-weight: 500;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .song-item-artist {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .song-item-duration {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .song-item-play {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .song-item-play:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .song-item-play i {
            margin-left: 2px;
        }

        /* Grid View */
        .songs-grid {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }

        .songs-grid.active {
            display: grid;
        }

        #playlistsGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }

        .card {
            background: rgba(255, 255, 255, 0.18);
            backdrop-filter: blur(20px) saturate(180%);
            border-radius: 20px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover::before {
            opacity: 1;
        }

        .card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 12px 40px rgba(31, 38, 135, 0.25);
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .card img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            border-radius: 16px;
            margin-bottom: 12px;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .card:hover img {
            transform: scale(1.05);
        }

        .card h3 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .card p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 10px 18px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }

        .btn i {
            font-size: 0.85rem;
        }

        /* Player - Sticky at bottom with expandable panel */
        .player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(102, 126, 234, 0.41);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 230px;
            overflow: hidden;
        }

        .player.expanded {
            max-height: 90%;
            overflow: hidden;
            /* Container doesn't scroll, children do */
            display: flex;
            flex-direction: column;
        }

        /* Sticky top section - player content stays visible */
        .player.expanded .player-content {
            flex-shrink: 0;
            /* Don't shrink */
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Scrollable bottom section - video details scroll independently */
        .player.expanded .video-details-panel {
            flex: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* Video Mode Expanded - Hide main controls bar, show inline controls below video */
        .player.expanded.video-mode-expanded .player-content {
            display: none;
            /* Hide the main controls when video is expanded */
        }

        /* Inline controls bar that appears below video in expanded video mode */
        .video-inline-controls {
            display: none;
            max-width: 900px;
            margin: 0 auto;
            padding: 12px 20px;
        }

        .player.expanded.video-mode-expanded .video-inline-controls {
            display: block;
        }

        /* Video Song Info (shown below video in desktop video mode only) */
        .video-song-info {
            display: none;
            /* Hidden by default */
            text-align: left;
            /* Left align in desktop right panel */
            padding: 10px 15px;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .player.expanded.video-mode-expanded .video-song-info {
            display: block;
            /* Visible in video mode expanded */
        }

        /* Desktop: show song info below video, hide in right panel */
        @media (min-width: 769px) {
            .player.expanded.video-mode-expanded #videoDetailsContent .video-song-info {
                display: none !important;
            }
        }

        /* Mobile: hide sticky song info (only show in right panel which scrolls) */
        @media (max-width: 768px) {
            .player.expanded.video-mode-expanded .video-sticky-wrapper .video-song-info {
                display: none !important;
            }
        }

        .video-song-info h3 {
            margin: 0 0 4px 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .video-song-info p {
            margin: 0;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .video-inline-controls .control-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: center;
            margin-bottom: 8px;
        }

        .video-inline-controls .progress-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .player-content {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 20px;
            position: relative;
        }

        /* Expand/Collapse Button */
        .expand-btn {
            position: absolute;
            top: -13px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 30px;
            width: 98px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: white;
            font-size: 0.9rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            pointer-events: none;
            z-index: 1001;
        }

        .player.has-song .expand-btn {
            opacity: 1;
            pointer-events: all;
        }

        .expand-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .expand-btn i {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .player.expanded .expand-btn i {
            transform: rotate(180deg);
        }

        /* Video Details Panel */
        .video-details-panel {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease, opacity 0.35s ease;
            will-change: max-height, opacity;
        }

        .player.expanded .video-details-panel {
            opacity: 1;
            max-height: none;
            display: flex;
            flex-direction: column;
            /* Default: vertical layout for audio mode */
        }

        /* Desktop VIDEO MODE ONLY: side-by-side layout */
        .player.expanded.video-mode-expanded .video-details-panel {
            flex-direction: row;
            /* Desktop video: side-by-side layout */
            gap: 20px;
        }

        /* Desktop VIDEO MODE: Video + controls on left side */
        .player.expanded.video-mode-expanded .video-details-panel .video-sticky-wrapper {
            flex: 0 0 60%;
            /* Left side: 60% width */
            max-width: 60%;
            position: sticky;
            top: 0;
            z-index: 10;
            align-self: flex-start;
            /* Stick to top */
            height: fit-content;
        }

        /* Desktop VIDEO MODE: Details/comments/songs on right side */
        .player.expanded.video-mode-expanded .video-details-panel #videoDetailsContent {
            flex: 0 0 38%;
            /* Right side: ~40% width */
            max-width: 38%;
            overflow-y: auto;
            max-height: 70vh;
        }

        /* Video container inside wrapper */
        .player.expanded .video-details-panel .video-container {
            flex-shrink: 0;
        }

        /* Inline controls inside wrapper */
        .player.expanded .video-details-panel .video-inline-controls {
            margin-bottom: 15px;
        }

        /* Scrollable content area */
        .player.expanded .video-details-panel .expandable-sections-wrapper {
            flex: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .details-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .details-section h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .details-section h3 i {
            color: rgba(255, 255, 255, 0.7);
        }

        .video-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .stat-item i {
            color: rgba(255, 255, 255, 0.8);
        }

        .video-description {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9rem;
        }

        /* Comments Section */
        .comments-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .comment {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 3px solid rgba(255, 255, 255, 0.2);
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .comment-author {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .comment-date {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            margin-left: auto;
        }

        .comment-text {
            margin-bottom: 8px;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .comment-footer {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .comment-likes {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .comment-replies {
            margin-left: 30px;
            margin-top: 10px;
        }

        .comment-reply {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 2px solid rgba(255, 255, 255, 0.15);
        }

        .loading-spinner {
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
        }

        .loading-spinner i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .error-message {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.4);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            color: #fff;
        }

        /* ============================================
           EXPANDABLE SECTION STYLES - Collapsible with Scroll
           ============================================ */
        .expandable-section {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .expandable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease;
        }

        .expandable-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .expandable-header h3 {
            margin: 0;
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(255, 255, 255, 0.95);
        }

        .expandable-header h3 i {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        /* Header with inline stats (Video Info section) */
        .header-with-stats {
            flex: 1;
        }

        .video-stats-inline {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .stat-inline {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.85);
        }

        .stat-inline i {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Header with comment preview (Comments section) */
        .header-with-preview {
            flex: 1;
            min-width: 0;
            /* Allow truncation */
        }

        .comment-preview {
            margin: 4px 0 0 0;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .expandable-header .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Collapsed State - Content Hidden */
        .expandable-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                padding 0.3s ease;
            padding: 0 18px;
        }

        /* Expanded State - Content Visible with Scroll */
        .expandable-section.expanded .expandable-content {
            max-height: 40vh;
            padding: 0 18px 18px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .expandable-section.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        /* Comments Section - Scrollable List */
        #commentsSection.expanded .expandable-content {
            max-height: 35vh;
        }

        /* Suggested Songs Section - Scrollable List */
        #suggestedSongsSection.expanded .expandable-content {
            max-height: 45vh;
        }

        /* Video Details Section - Less scroll needed */
        #videoDetailsSection.expanded .expandable-content {
            max-height: 30vh;
        }

        /* ============================================
           SUGGESTED SONGS SECTION STYLES
           ============================================ */
        .suggested-songs-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .suggested-song-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.15s ease;
        }

        .suggested-song-item:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateX(4px);
        }

        .suggested-song-item img {
            width: 48px;
            height: 48px;
            border-radius: 6px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .suggested-song-info {
            flex: 1;
            min-width: 0;
        }

        .suggested-song-title {
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .suggested-song-artist {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .suggested-song-duration {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            flex-shrink: 0;
        }

        /* Suggested Songs Section (plain, no expandable) */
        .suggested-songs-section {
            margin-top: 16px;
        }

        .section-header {
            font-size: 0.95rem;
            font-weight: 600;
            margin: 0 0 12px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(255, 255, 255, 0.95);
        }

        /* ============================================
           SONG INFO SECTION STYLES
           ============================================ */
        .song-info-section {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            overflow: hidden;
        }

        .song-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease;
        }

        .song-info-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .song-info-header h3 {
            margin: 0;
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(255, 255, 255, 0.95);
        }

        .song-info-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), padding 0.3s ease;
            padding: 0 18px;
        }

        .song-info-section.expanded .song-info-content {
            max-height: 500px;
            padding: 0 18px 18px;
            overflow-y: auto;
        }

        .song-info-section.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .song-info-loading {
            text-align: center;
            padding: 30px;
            color: rgba(255, 255, 255, 0.7);
        }

        .song-info-loading i {
            font-size: 1.5rem;
            margin-bottom: 10px;
            animation: spin 1s linear infinite;
        }

        /* Credit Cards */
        .credit-card {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .credit-card.main-artist {
            padding: 18px;
        }

        .credit-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(102, 126, 234, 0.5);
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.1);
        }

        .credit-card.main-artist .credit-photo {
            width: 70px;
            height: 70px;
        }

        .credit-info {
            flex: 1;
            min-width: 0;
        }

        .credit-name {
            font-size: 1rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 2px;
        }

        .credit-role {
            font-size: 0.75rem;
            font-style: italic;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 6px;
        }

        .credit-bio {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.4;
        }

        /* Two-column layout for Music Director & Lyricist */
        .credits-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        @media (max-width: 600px) {
            .credits-row {
                grid-template-columns: 1fr;
            }
        }

        .credits-row .credit-card {
            margin-bottom: 0;
        }

        .credits-row .credit-photo {
            width: 50px;
            height: 50px;
        }

        .credits-row .credit-name {
            font-size: 0.9rem;
        }

        .credits-row .credit-bio {
            font-size: 0.8rem;
        }

        /* Movie Info */
        .movie-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 15px;
            background: rgba(102, 126, 234, 0.15);
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.85);
        }

        .movie-info i {
            color: rgba(255, 255, 255, 0.6);
        }

        .source-info-detail {
            padding: 8px 15px;
            background: rgba(102, 126, 234, 0.08);
            border-radius: 0 0 8px 8px;
            margin-top: -8px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.4;
        }

        /* Default avatar placeholder */
        .credit-photo-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.5);
            flex-shrink: 0;
        }

        .section-header i {
            color: rgba(255, 255, 255, 0.7);
        }

        /* Sections container for proper ordering */
        .expandable-sections-wrapper {
            display: flex;
            flex-direction: column;
            padding: 0 20px 20px;
        }

        /* CD Player Animation */
        .cd-player {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto 20px;
        }

        .cd-disc {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            position: relative;
            animation: rotate 20s linear infinite;
            animation-play-state: paused;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), inset 0 0 40px rgba(0, 0, 0, 0.3);
        }

        .cd-disc.playing {
            animation-play-state: running;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .cd-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 140px;
            height: 140px;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border: 3px solid rgba(255, 255, 255, 0.1);
        }

        .cd-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .cd-hole {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a1a2e, #0f0f1e);
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.8);
        }

        /* Song Info */
        .song-info {
            flex: 1;
            min-width: 150px;
        }

        .song-info h3 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .song-info p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.75rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Player Controls */
        .player-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 2;
            min-width: 280px;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: center;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .control-btn.play-pause {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            font-size: 1rem;
            border: none;
        }

        .control-btn.play-pause:hover {
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .control-btn i {
            pointer-events: none;
        }

        .control-btn.play-pause i {
            margin-left: 2px;
        }

        /* Progress Bar */
        .progress-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            min-width: 38px;
            font-variant-numeric: tabular-nums;
        }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            transition: height 0.2s ease;
        }

        .progress-bar:hover {
            height: 8px;
        }

        /* Buffered progress (light gray) - shows loaded portion */
        .buffered-progress {
            position: absolute;
            height: 100%;
            background: rgba(255, 255, 255, 0.4);
            width: 0%;
            transition: width 0.3s ease;
            z-index: 1;
        }

        /* Current playback progress (gradient) */
        .progress {
            position: absolute;
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.1s linear;
            z-index: 2;
        }

        /* Seek handle (appears on hover) */
        .progress::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .progress-bar:hover .progress::after {
            opacity: 1;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(30, 30, 50, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            max-width: 460px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

        .modal-content h2 {
            margin-bottom: 20px;
            font-size: 1.4rem;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 12px;
            color: #fff;
            font-size: 0.95rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        .loading-spinner {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        .loading-spinner i {
            font-size: 1.5rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .end-of-results {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .header-top {
                flex-direction: row;
                align-items: stretch;
            }

            .header-left {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }

            .logo {
                font-size: 1.3rem;
            }

            .logo-icon {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }

            .logo-text {
                display: none;
            }

            .tabs {
                justify-content: center;
                width: 100%;
            }

            .header-right {
                flex-direction: row;
                align-items: center;
                gap: 10px;
                width: 70%;
            }

            .search-container {
                flex: 1;
                max-width: 100%;
            }

            .view-toggle {
                justify-content: center;
            }

            .songs-grid,
            #playlistsGrid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 10px 15px;
            }

            .container {
                padding: 15px;
            }

            .logo {
                font-size: 1.1rem;
            }

            .logo-icon {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }

            .logo-text {
                font-size: 1.1rem;
            }

            .tabs {
                gap: 6px;
                display: none;
            }

            .tab {
                padding: 6px 14px;
                font-size: 0.85rem;
            }

            .search-container {
                padding: 4px 15px;
            }

            .search-container input {
                font-size: 0.85rem;
            }

            .search-container button {
                padding: 6px 16px;
                font-size: 0.8rem;
            }

            .settings-icon {
                width: 38px;
                height: 38px;
                font-size: 1rem;
            }

            .dialog {
                width: 95%;
                max-width: 95%;
            }

            .dialog-header {
                padding: 16px 18px;
            }

            .dialog-header h2 {
                font-size: 1.1rem;
            }

            .dialog-body {
                padding: 18px;
            }

            .settings-option {
                padding: 12px;
            }

            .view-btn {
                padding: 10px 14px;
                font-size: 0.85rem;
            }

            .songs-grid,
            #playlistsGrid {
                gap: 12px;
            }

            .card {
                padding: 12px;
            }

            .card img {
                height: 140px;
            }

            .song-item {
                padding: 10px;
                gap: 10px;
            }

            .song-item img {
                width: 45px;
                height: 45px;
            }

            .song-item-title {
                font-size: 0.9rem;
            }

            .song-item-artist {
                font-size: 0.75rem;
            }

            .song-item-duration {
                font-size: 0.75rem;
            }

            .song-item-play {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }

            /* Player responsive */
            .player {
                max-height: 160px;
            }

            .player-content {
                flex-wrap: wrap;
                gap: 12px;
                padding: 10px 15px;
            }

            .expand-btn {
                width: 63px;
                height: 32px;
                font-size: 1rem;
                top: -19px;
            }

            .video-details-panel {
                padding: 15px;
            }

            .details-section {
                padding: 15px;
            }

            .video-stats {
                gap: 10px;
            }

            .stat-item {
                font-size: 0.8rem;
                padding: 6px 12px;
            }

            .comment-avatar {
                width: 32px !important;
                height: 32px !important;
            }

            .cd-disc {
                width: 120px;
                height: 120px;
            }

            .cd-center {
                width: 85px;
                height: 85px;
            }

            .cd-hole {
                width: 30px;
                height: 30px;
            }

            .song-info {
                flex: 1;
                min-width: 120px;
            }

            .song-info h3 {
                font-size: 0.85rem;
            }

            .song-info p {
                font-size: 0.7rem;
            }

            .player-controls {
                width: 100%;
                min-width: auto;
            }

            .control-buttons {
                gap: 6px;
            }

            .control-btn {
                width: 32px;
                height: 32px;
                font-size: 0.8rem;
            }

            .control-btn.play-pause {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .time {
                font-size: 0.65rem;
                min-width: 35px;
            }

            /* Mobile - Larger touch target for progress bar */
            .progress-bar {
                height: 8px !important;
                touch-action: none;
                /* Prevent scrolling while dragging */
            }

            .progress-bar:active {
                height: 12px !important;
            }

            /* Mobile - Always show seek handle for better visibility */
            .progress::after {
                opacity: 0.7 !important;
                width: 14px !important;
                height: 14px !important;
            }

            .progress-bar:active .progress::after {
                opacity: 1 !important;
                width: 16px !important;
                height: 16px !important;
            }

            /* Mobile - Better buffered bar visibility */
            .buffered-progress {
                background: rgba(255, 255, 255, 0.5) !important;
            }

            .modal-content {
                padding: 20px;
                max-width: 90%;
            }

            /* Mobile - Expandable Sections */
            .expandable-section {
                margin-bottom: 10px;
                border-radius: 10px;
            }

            .expandable-header {
                padding: 12px 14px;
            }

            .expandable-header h3 {
                font-size: 0.9rem;
            }

            /* Mobile: Use more viewport height since screen is taller */
            .expandable-section.expanded .expandable-content {
                max-height: 50vh;
                padding: 0 14px 14px;
            }

            #commentsSection.expanded .expandable-content {
                max-height: 45vh;
            }

            #suggestedSongsSection.expanded .expandable-content {
                max-height: 55vh;
            }

            #videoDetailsSection.expanded .expandable-content {
                max-height: 35vh;
            }

            .expandable-sections-wrapper {
                padding: 0 0px 0px;
            }

            /* Mobile: Restore vertical layout for video details panel */
            .player.expanded .video-details-panel {
                flex-direction: column;
                /* Stack vertically on mobile */
            }

            /* Mobile VIDEO MODE: full width and vertical layout */
            .player.expanded.video-mode-expanded .video-details-panel {
                flex-direction: column;
                /* Override desktop row to column */
                gap: 10px;
                overflow-y: auto;
            }

            .player.expanded.video-mode-expanded .video-details-panel .video-sticky-wrapper {
                flex: none;
                max-width: 100%;
                /* Full width on mobile */
                width: 100%;
                position: sticky;
                /* Sticky on mobile - video + controls stay at top */
                top: 0;
                z-index: 10;
            }

            .player.expanded.video-mode-expanded .video-details-panel #videoDetailsContent {
                flex: none;
                max-width: 100%;
                /* Full width on mobile */
                width: 100%;
                max-height: none;
                overflow: visible;
            }

            /* Mobile - Sticky player layout */
            .player.expanded {
                display: flex;
                flex-direction: column;
            }

            .player.expanded .player-content {
                flex-shrink: 0;
                position: sticky;
                top: 0;
                z-index: 10;
            }

            .player.expanded .video-details-panel {
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                /* Smooth scroll on iOS */
            }

            /* Mobile - Video mode sticky video */
            .player.expanded .video-details-panel .video-container.active {
                position: sticky;
                top: 0;
                z-index: 6;
            }

            /* ============================================
               MOBILE EXPANDED VIDEO CONTROLS
               All controls inside video player overlay
               Hide controls bar below video
               ============================================ */

            /* Hide inline controls bar below video in mobile expanded mode */
            .player.expanded.video-mode-expanded .video-inline-controls {
                display: none !important;
            }

            /* Video overlay - Hidden by default, show on interaction */
            .player.expanded.video-mode-expanded .video-controls-overlay {
                background: linear-gradient(to top,
                        rgba(0, 0, 0, 0.85) 0%,
                        rgba(0, 0, 0, 0.4) 30%,
                        transparent 60%);
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
            }

            /* Show controls when visible class is added */
            .player.expanded.video-mode-expanded .video-controls-overlay.visible {
                opacity: 1;
                pointer-events: all;
            }

            /* Center controls row: prev / play / next */
            .player.expanded.video-mode-expanded .video-center-controls {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 20px;
                margin: auto;
            }

            /* Side buttons (prev/next) */
            .player.expanded.video-mode-expanded .video-side-btn {
                width: 38px;
                height: 38px;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.15);
                backdrop-filter: blur(8px);
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: rgba(255, 255, 255, 0.9);
                font-size: 0.9rem;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
            }

            .player.expanded.video-mode-expanded .video-side-btn:active {
                background: rgba(255, 255, 255, 0.3);
                transform: scale(0.95);
            }

            /* Center play button */
            .player.expanded.video-mode-expanded .video-center-play {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.4);
            }

            .player.expanded.video-mode-expanded .video-center-play:active {
                background: rgba(255, 255, 255, 0.35);
                transform: scale(0.95);
            }

            /* Bottom bar - thin and compact */
            .player.expanded.video-mode-expanded .video-bottom-bar {
                padding: 8px 12px;
                gap: 6px;
            }

            /* Thin progress bar */
            .player.expanded.video-mode-expanded .video-overlay-progress {
                height: 3px;
                background: rgba(255, 255, 255, 0.3);
                border-radius: 2px;
            }

            .player.expanded.video-mode-expanded .video-overlay-progress-fill {
                background: #fff;
                border-radius: 2px;
            }

            /* Control row with all buttons */
            .player.expanded.video-mode-expanded .video-overlay-controls {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
            }

            /* Left side: time display */
            .player.expanded.video-mode-expanded .video-time {
                font-size: 0.7rem;
                color: rgba(255, 255, 255, 0.9);
                min-width: 65px;
            }

            /* Center: control buttons row */
            .player.expanded.video-mode-expanded .video-overlay-buttons {
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .player.expanded.video-mode-expanded .video-overlay-btn {
                background: rgba(255, 255, 255, 0.15);
                backdrop-filter: blur(5px);
                border: none;
                color: rgba(255, 255, 255, 0.9);
                width: 28px;
                height: 28px;
                border-radius: 50%;
                font-size: 0.75rem;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
            }

            .player.expanded.video-mode-expanded .video-overlay-btn:active {
                background: rgba(255, 255, 255, 0.3);
                transform: scale(0.95);
            }

            /* Right side: settings */
            .player.expanded.video-mode-expanded .video-settings-btn {
                background: transparent;
                width: 28px;
                height: 28px;
                font-size: 0.85rem;
                opacity: 0.8;
            }
        }

        @media (max-width: 480px) {
            .header-content {
                gap: 8px;
            }

            .tabs {
                gap: 4px;
            }

            .tab {
                padding: 5px 10px;
                font-size: 0.8rem;
            }

            .view-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }

            .cd-disc {
                width: 80px;
                height: 80px;
            }

            .cd-center {
                width: 55px;
                height: 55px;
            }

            .cd-hole {
                width: 20px;
                height: 20px;
            }

            .control-btn {
                width: 28px;
                height: 28px;
                font-size: 0.75rem;
            }

            .control-btn.play-pause {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
            }

            .songs-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            /* Small Mobile - Even more vertical space for scrolling */
            .expandable-section.expanded .expandable-content {
                max-height: 55vh;
            }

            #commentsSection.expanded .expandable-content {
                max-height: 50vh;
            }

            #suggestedSongsSection.expanded .expandable-content {
                max-height: 60vh;
            }
        }

        /* Video.js Player Styles - Dual Mode */
        /* Video player container - hidden by default, shown in video mode */
        .video-player-wrapper {
            display: none;
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        .video-player-wrapper.video-mode {
            display: block;
        }

        #videoPlayer {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Hide Video.js default controls - we use custom */
        .video-js .vjs-control-bar,
        .video-js .vjs-big-play-button,
        .video-js .vjs-loading-spinner,
        .video-js .vjs-text-track-display,
        .video-js .vjs-modal-dialog {
            display: none !important;
        }

        .video-js {
            background-color: transparent !important;
        }

        /* Expanded video in YouTube mobile style */
        .video-details-panel.expanded .video-container {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .video-details-panel.expanded .video-container .video-player-wrapper {
            display: block;
            width: 100%;
            height: 100%;
            border-radius: 0;
        }

        .video-details-panel.expanded .video-container #videoPlayer {
            border-radius: 0;
        }

        /* Video Controls Overlay - shown on hover */
        .video-controls-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom,
                    rgba(0, 0, 0, 0.1) 0%,
                    transparent 30%,
                    transparent 70%,
                    rgba(0, 0, 0, 0.7) 100%);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 10;
            border-radius: inherit;
        }

        .video-player-wrapper:hover .video-controls-overlay,
        .video-controls-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        .video-center-play {
            margin: auto;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid white;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-center-play:hover {
            background: rgba(255, 0, 0, 0.8);
            transform: scale(1.1);
        }

        .video-bottom-bar {
            width: 100%;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .video-overlay-progress {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .video-overlay-progress-fill {
            height: 100%;
            background: #ff0000;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .video-overlay-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Hide new center controls by default (only show in expanded video mode) */
        .video-center-controls {
            display: none;
        }

        .video-side-btn {
            display: none;
        }

        .video-overlay-buttons {
            display: none;
        }

        .video-time {
            color: white;
            font-size: 0.65rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .video-settings-btn {
            background: transparent;
            border: none;
            color: white;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: color 0.2s ease;
            opacity: 0.8;
        }

        .video-settings-btn:hover {
            color: #ff0000;
            opacity: 1;
        }

        /* ============================================
           DESKTOP EXPANDED VIDEO MODE CONTROLS
           Same theme as mobile, hide inline controls
           ============================================ */

        /* Hide inline controls bar below video in desktop expanded video mode */
        .player.expanded.video-mode-expanded .video-inline-controls {
            display: none !important;
        }

        /* Desktop - Show center controls row */
        .player.expanded.video-mode-expanded .video-center-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: auto;
        }

        /* Desktop - Side buttons (prev/next) - same size as mobile */
        .player.expanded.video-mode-expanded .video-side-btn {
            display: flex;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .player.expanded.video-mode-expanded .video-side-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        /* Desktop - Center play button - same size as mobile */
        .player.expanded.video-mode-expanded .video-center-play {
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .player.expanded.video-mode-expanded .video-center-play:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(1.05);
        }

        /* Desktop - Bottom bar */
        .player.expanded.video-mode-expanded .video-bottom-bar {
            padding: 8px 12px;
            gap: 6px;
        }

        /* Desktop - Overlay buttons (shuffle/video toggle) */
        .player.expanded.video-mode-expanded .video-overlay-buttons {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .player.expanded.video-mode-expanded .video-overlay-btn {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
            border: none;
            color: rgba(255, 255, 255, 0.9);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .player.expanded.video-mode-expanded .video-overlay-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Quality Selection Menu */
        .quality-menu {
            position: absolute;
            bottom: 100%;
            right: 5px;
            margin-bottom: 5px;
            background: rgba(28, 28, 28, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 8px 0;
            min-width: 120px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 30;
            display: none;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .quality-menu.visible {
            display: block;
        }

        .quality-menu-header {
            padding: 6px 12px;
            font-weight: 600;
            color: #888;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 4px;
        }

        .quality-option {
            padding: 8px 12px;
            cursor: pointer;
            color: white;
            transition: background 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }

        .quality-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .quality-option.active {
            background: rgba(255, 0, 0, 0.15);
            color: #ff4444;
        }

        .quality-option .checkmark {
            color: #ff4444;
            font-size: 0.75rem;
        }

        /* Expanded view - larger video wrapper */
        .video-details-panel.expanded .video-player-wrapper .video-controls-overlay {
            border-radius: 0;
        }

        .video-details-panel.expanded .video-center-play {
            width: 70px;
            height: 70px;
            font-size: 1.5rem;
        }

        /* ============================================
           EXPANDED VIDEO CONTAINER - YouTube-like centered layout
           ============================================ */
        .video-container.active {
            display: block !important;
            width: 100%;
            max-width: 900px;
            margin: 0 auto 20px;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .video-container.active .video-player-wrapper {
            display: block !important;
            width: 100% !important;
            height: 100% !important;
            border-radius: 0 !important;
        }

        .video-container.active #videoPlayer,
        .video-container.active .video-js {
            width: 100% !important;
            height: 100% !important;
            object-fit: contain;
            border-radius: 0 !important;
        }

        .video-container.active .video-controls-overlay {
            border-radius: 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .video-container.active:hover .video-controls-overlay,
        .video-container.active .video-controls-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        .video-container.active .video-center-play {
            width: 70px;
            height: 70px;
            font-size: 1.5rem;
        }

        .video-container.active .quality-menu {
            bottom: 60px;
            right: 15px;
        }

        .video-container.active .video-bottom-bar {
            padding: 12px 15px;
        }

        .video-container.active .video-time {
            font-size: 0.8rem;
        }

        /* ============================================
           MOBILE RESPONSIVE - Expanded video
           ============================================ */
        @media (max-width: 768px) {
            .video-container.active {
                max-width: 100%;
                border-radius: 8px;
                margin: 0 auto 15px;
            }

            .video-container.active .video-center-play {
                width: 55px;
                height: 55px;
                font-size: 1.2rem;
            }

            .video-container.active .quality-menu {
                bottom: 50px;
                right: 10px;
                min-width: 100px;
            }

            .video-container.active .quality-option {
                padding: 6px 10px;
                font-size: 0.75rem;
            }
        }

        /* ============================================
           MOBILE - Unexpanded player adjustments
           ============================================ */
        @media (max-width: 768px) {

            /* Smaller video wrapper in player bar for mobile */
            .video-player-wrapper.video-mode {
                width: 80px;
                height: 80px;
            }

            /* Always show video controls on mobile (unexpanded) - touch-friendly */
            .player-content .video-player-wrapper.video-mode .video-controls-overlay {
                opacity: 1;
                pointer-events: all;
            }

            /* Smaller center play button for mobile unexpanded */
            .player-content .video-player-wrapper.video-mode .video-center-play {
                width: 32px;
                height: 32px;
                font-size: 0.8rem;
            }

            /* Hide settings and progress in unexpanded mobile view (too small) */
            .player-content .video-player-wrapper.video-mode .video-settings-btn,
            .player-content .video-player-wrapper.video-mode .video-overlay-progress,
            .player-content .video-player-wrapper.video-mode .video-time {
                display: none;
            }

            /* Adjust video bottom bar for mobile unexpanded */
            .player-content .video-player-wrapper.video-mode .video-bottom-bar {
                display: none;
            }
        }

        /* Desktop: Keep controls hidden until hover for unexpanded */
        @media (min-width: 769px) {
            .player-content .video-player-wrapper .video-controls-overlay {
                opacity: 0;
            }

            .player-content .video-player-wrapper:hover .video-controls-overlay {
                opacity: 1;
                pointer-events: all;
            }
        }
    </style>
</head>

<body>
    <!-- Watermark Sphere -->
    <div class="watermark-sphere">
        <div class="sphere-container">
            <i class="fas fa-headphones headphones-icon"></i>
            <div class="sphere"></div>
        </div>
    </div>

    <!-- Sticky Header -->
    <div class="header">
        <div class="header-content">
            <div class="header-top">
                <div class="header-left">
                    <a href="#" class="logo">
                        <div class="logo-icon">
                            <i class="fas fa-music"></i>
                        </div>
                        <span class="logo-text">YT Music</span>
                    </a>
                    <div class="tabs">
                        <div class="tab active" data-tab="songs"><i class="fas fa-music"></i> Songs</div>
                        <div class="tab" data-tab="playlists"><i class="fas fa-list-ul"></i> Playlists</div>
                        <div class="tab" data-tab="history"><i class="fas fa-history"></i> History</div>
                        <div class="tab" data-tab="user"><i class="fas fa-user"></i> Account</div>
                    </div>
                </div>
                <div class="header-right">
                    <div class="search-container">
                        <input type="text" id="searchInput" placeholder="Search for songs, artists, albums..." />
                        <button onclick="searchSongs()"><i class="fas fa-search"></i> </button>
                    </div>
                    <div class="settings-icon" onclick="openSettingsDialog()">
                        <i class="fas fa-cog"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="container">
        <div class="content-wrapper">
            <!-- Songs Tab -->
            <div class="content active" id="songs">
                <div class="songs-list active" id="songsList"></div>
                <div class="songs-grid" id="songsGrid"></div>
            </div>

            <!-- Playlists Tab -->
            <div class="content" id="playlists">
                <button class="btn btn-primary" onclick="showCreatePlaylistModal()" style="margin-bottom: 20px;">
                    <i class="fas fa-plus"></i> Create Playlist
                </button>
                <div id="playlistsGrid"></div>
            </div>

            <!-- History Tab -->
            <div class="content" id="history">
                <div id="historyList"></div>
            </div>

            <!-- User/Login Tab -->
            <div class="content" id="user">
                <div id="loginSection">
                    <div class="card" style="max-width: 400px; margin: 0 auto;">
                        <h2 style="margin-bottom: 20px;">Login</h2>
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="loginUsername" />
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="loginPassword" />
                        </div>
                        <button class="btn btn-primary" onclick="login()" style="width: 100%;">Login</button>
                        <p
                            style="margin-top: 15px; text-align: center; color: rgba(255,255,255,0.7); font-size: 0.85rem;">
                            Don't have an account? <a href="#" onclick="showSignup()"
                                style="color: #a8b8ff; text-decoration: none;">Sign up</a>
                        </p>
                    </div>
                </div>
                <div id="userInfo" style="display: none;">
                    <div class="card" style="max-width: 400px; margin: 0 auto;">
                        <h2 style="margin-bottom: 20px;">Account Info</h2>
                        <p style="margin-bottom: 10px;"><strong>Username:</strong> <span id="userUsername"></span></p>
                        <p style="margin-bottom: 20px;"><strong>Email:</strong> <span id="userEmail"></span></p>
                        <button class="btn" onclick="logout()" style="width: 100%;">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sticky Music Player with Expandable Details -->
    <div class="player" id="musicPlayer">
        <!-- Video.js Player (hidden, used for playback) -->
        <video id="videoPlayer" class="video-js" preload="auto" playsinline></video>

        <!-- Expand/Collapse Button -->
        <button class="expand-btn" onclick="togglePlayerExpand()" title="Click to view video details, comments & more">
            <i class="fas fa-chevron-up"></i>
        </button>

        <div class="player-content">
            <!-- CD Disc (visible in audio-only mode) -->
            <div class="cd-disc" id="albumDisk">
                <div class="cd-center">
                    <img id="albumArt" src="https://via.placeholder.com/140?text=" class="cd-thumbnail"
                        alt="Album Art">
                </div>
                <div class="cd-hole"></div>
            </div>

            <!-- Video Player Wrapper (visible in video mode, replaces CD disc) -->
            <div class="video-player-wrapper" id="videoPlayerWrapper">
                <!-- Video element will be moved here when in video mode -->

                <!-- Video Controls Overlay (shown on hover in video mode) -->
                <div class="video-controls-overlay" id="videoControlsOverlay">
                    <!-- Center controls: prev / play / next -->
                    <div class="video-center-controls">
                        <button class="video-side-btn" onclick="previousSong()" title="Previous">
                            <i class="fas fa-step-backward"></i>
                        </button>
                        <button class="video-center-play" onclick="togglePlay()">
                            <i class="fas fa-play" id="videoCenterPlayIcon"></i>
                        </button>
                        <button class="video-side-btn" onclick="nextSong()" title="Next">
                            <i class="fas fa-step-forward"></i>
                        </button>
                    </div>

                    <!-- Bottom bar: progress + controls -->
                    <div class="video-bottom-bar">
                        <div class="video-overlay-progress" onclick="seekToVideo(event)">
                            <div class="video-overlay-progress-fill" id="videoOverlayProgress"></div>
                        </div>
                        <div class="video-overlay-controls">
                            <span class="video-time" id="videoTimeDisplay">0:00 / 0:00</span>
                            <div class="video-overlay-buttons">
                                <button class="video-overlay-btn" onclick="toggleShuffle()" id="overlayShuffleBtn"
                                    title="Playback Mode">
                                    <i class="fas fa-random"></i>
                                </button>
                                <button class="video-overlay-btn" onclick="toggleVideoMode()" id="overlayVideoModeBtn"
                                    title="Switch to Audio">
                                    <i class="fas fa-music"></i>
                                </button>
                                <button class="video-overlay-btn" onclick="toggleFullscreen()" id="fullscreenBtn"
                                    title="Fullscreen">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                            <button class="video-settings-btn" onclick="toggleQualityMenu(event)">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quality Selection Menu -->
                <div class="quality-menu" id="qualityMenu">
                    <div class="quality-menu-header">Quality</div>
                    <div class="quality-options" id="qualityOptions">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </div>

            <div class="song-info">
                <h3 id="currentSongTitle">No song playing</h3>
                <p id="currentSongArtist">Select a song to play</p>
            </div>

            <div class="player-controls">
                <div class="control-buttons">
                    <button class="control-btn" onclick="previousSong()" title="Previous"><i
                            class="fas fa-step-backward"></i></button>
                    <button class="control-btn play-pause" onclick="togglePlay()" id="playPauseBtn"
                        title="Play/Pause"><i class="fas fa-play"></i></button>
                    <button class="control-btn" onclick="stopSong()" title="Stop"><i class="fas fa-stop"></i></button>
                    <button class="control-btn" onclick="nextSong()" title="Next"><i
                            class="fas fa-step-forward"></i></button>
                    <button class="control-btn" onclick="toggleShuffle()" id="shuffleBtn" style="opacity: 0.5;"
                        title="Shuffle"><i class="fas fa-random"></i></button>
                    <button class="control-btn" onclick="toggleVideoMode()" id="videoModeBtn" style="opacity: 0.3;"
                        title="Toggle Video" disabled><i class="fas fa-tv"></i></button>
                </div>

                <div class="progress-container">
                    <span class="time" id="currentTime">0:00</span>
                    <div class="progress-bar">
                        <div class="buffered-progress" id="bufferedBar"></div>
                        <div class="progress" id="progressBar"></div>
                    </div>
                    <span class="time" id="duration">0:00</span>
                </div>
            </div>
        </div>

        <!-- Video Details Panel (Expandable) -->
        <div class="video-details-panel" id="videoDetailsPanel">
            <!-- Sticky wrapper for video + controls (sticks together like audio mode) -->
            <div class="video-sticky-wrapper">
                <!-- Video Container for YouTube mobile-style layout when expanded in video mode -->
                <div class="video-container" id="expandedVideoContainer" style="display: none;">
                    <!-- Video will be displayed here when expanded in video mode -->
                </div>

                <!-- Inline Controls (shown below video in video mode expanded) -->
                <div class="video-inline-controls" id="videoInlineControls">
                    <div class="control-buttons">
                        <button class="control-btn" onclick="previousSong()" title="Previous"><i
                                class="fas fa-step-backward"></i></button>
                        <button class="control-btn play-pause" onclick="togglePlay()" id="inlinePlayPauseBtn"
                            title="Play/Pause"><i class="fas fa-play"></i></button>
                        <button class="control-btn" onclick="stopSong()" title="Stop"><i
                                class="fas fa-stop"></i></button>
                        <button class="control-btn" onclick="nextSong()" title="Next"><i
                                class="fas fa-step-forward"></i></button>
                        <button class="control-btn" onclick="toggleShuffle()" id="inlineShuffleBtn"
                            style="opacity: 0.5;" title="Shuffle"><i class="fas fa-random"></i></button>
                        <button class="control-btn" onclick="toggleVideoMode()" id="inlineVideoModeBtn"
                            title="Toggle Video"><i class="fas fa-tv"></i></button>
                    </div>
                    <div class="progress-container">
                        <span class="time" id="inlineCurrentTime">0:00</span>
                        <div class="progress-bar" id="inlineProgressBar">
                            <div class="buffered-progress" id="inlineBufferedBar"></div>
                            <div class="progress" id="inlineProgress"></div>
                        </div>
                        <span class="time" id="inlineDuration">0:00</span>
                    </div>
                </div>

                <!-- Song Info (shown below video in desktop video mode) -->
                <div class="video-song-info">
                    <h3 id="videoSongTitle">No song playing</h3>
                    <p id="videoSongArtist">Select a song to play</p>
                </div>
            </div>

            <div id="videoDetailsContent">
                <!-- Other content will be loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Create Playlist Modal -->
    <div class="modal" id="createPlaylistModal">
        <div class="modal-content">
            <h2>Create Playlist</h2>
            <div class="form-group">
                <label>Playlist Name</label>
                <input type="text" id="playlistName" placeholder="My Playlist" />
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="playlistDescription" placeholder="Optional description..."></textarea>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="createPlaylist()" style="flex: 1;">Create</button>
                <button class="btn" onclick="closeModal()" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://music-app-920748930700.europe-west1.run.app/api/v1';
        let token = localStorage.getItem('token');
        let currentPlaylist = [];
        let currentSongIndex = -1;
        let isPlaying = false;

        // Playback Mode: 'off', 'shuffle', 'loop', 'repeat'
        // off = normal sequential, shuffle = random, loop = loop all, repeat = repeat one
        let playbackMode = 'off';

        let currentView = 'list';

        // Infinite Scroll State
        let currentSearchQuery = '';
        let currentContinuation = null;
        let isLoadingMore = false;
        let hasMoreResults = true;
        const SONGS_PER_PAGE = 20;

        // Video Details State
        let isPlayerExpanded = false;
        let currentVideoId = null;
        let videoDetailsCache = {};

        // Video.js Player State
        let player = null;

        // Video Settings - Load from localStorage with defaults
        let videoSettings = loadVideoSettings();
        let isVideoMode = videoSettings.preferVideoMode;  // User's preferred mode
        let preferredQuality = videoSettings.preferredQuality;  // User's preferred quality (default: 480p)

        let hasVideoStream = false;  // Track if current song has video available
        let currentStreamInfo = null;  // Store current stream info for mode switching

        // Quality Selection State
        let availableQualities = [];
        let currentQuality = 'audio_only';
        let qualityMenuVisible = false;
        let controlsHideTimeout = null;

        // Song Info State
        let songInfoCache = {};
        let isSongInfoLoading = false;
        let isSongInfoExpanded = false;

        // Load video settings from localStorage
        function loadVideoSettings() {
            const saved = localStorage.getItem('videoSettings');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading video settings:', e);
                }
            }
            // Default settings: audio mode, 480p quality
            return {
                preferVideoMode: false,
                preferredQuality: '480p'
            };
        }

        // Save video settings to localStorage
        function saveVideoSettings() {
            const settings = {
                preferVideoMode: isVideoMode,
                preferredQuality: preferredQuality
            };
            localStorage.setItem('videoSettings', JSON.stringify(settings));
            console.log('Video settings saved:', settings);
        }

        // ============================================
        // SONG INFO SECTION FUNCTIONS
        // ============================================

        // Toggle Song Info section expand/collapse
        function toggleSongInfoSection() {
            const section = document.getElementById('songInfoSection');
            const content = document.getElementById('songInfoContent');

            isSongInfoExpanded = !isSongInfoExpanded;
            section.classList.toggle('expanded', isSongInfoExpanded);

            // Lazy load: fetch data only when expanding and not already loaded
            if (isSongInfoExpanded && currentVideoId) {
                const song = currentPlaylist[currentSongIndex];
                if (song && !songInfoCache[currentVideoId]) {
                    fetchSongInfo(currentVideoId, song.title, song.artist);
                } else if (songInfoCache[currentVideoId]) {
                    renderSongInfo(songInfoCache[currentVideoId]);
                }
            }
        }

        // Fetch song info from API
        async function fetchSongInfo(videoId, songName, artist) {
            if (isSongInfoLoading) return;

            isSongInfoLoading = true;
            const content = document.getElementById('songInfoContent');

            // Show loading spinner
            content.innerHTML = `
                <div class="song-info-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <div>Loading song info...</div>
                </div>
            `;

            try {
                const params = new URLSearchParams({
                    song_name: songName || '',
                    artist: artist || ''
                });

                const response = await fetch(`${API_BASE}/music/song-info/${videoId}?${params}`);
                const data = await response.json();

                // Cache the result
                songInfoCache[videoId] = data;

                // Only render if still on same song
                if (currentVideoId === videoId) {
                    renderSongInfo(data);
                }
            } catch (error) {
                console.error('Error fetching song info:', error);
                content.innerHTML = `
                    <div class="song-info-loading">
                        <i class="fas fa-exclamation-circle"></i>
                        <div>Failed to load song info</div>
                    </div>
                `;
            } finally {
                isSongInfoLoading = false;
            }
        }

        // Render song info content
        function renderSongInfo(data) {
            const content = document.getElementById('songInfoContent');
            let html = '';

            // Singer card (always shown)
            const singer = data.singer || {};
            const singerPhoto = singer.photo_base64 || null;

            html += `<div class="credit-card main-artist">`;
            if (singerPhoto) {
                html += `<img class="credit-photo" src="${singerPhoto}" alt="${singer.name || 'Artist'}" onerror="this.style.display='none'">`;
            } else {
                html += `<div class="credit-photo-placeholder"><i class="fas fa-music"></i></div>`;
            }
            html += `
                <div class="credit-info">
                    <div class="credit-name">${singer.name || 'Unknown Artist'}</div>
                    <div class="credit-role">${singer.role || 'Singer'}</div>
                    ${singer.bio ? `<div class="credit-bio">${singer.bio}</div>` : ''}
                </div>
            </div>`;

            // Music Director & Lyricist row
            const musicDir = data.music_director;
            const lyricist = data.lyricist;

            if (musicDir || lyricist) {
                html += `<div class="credits-row">`;

                // Music Director
                if (musicDir && musicDir.name) {
                    const mdPhoto = musicDir.photo_base64 || null;
                    html += `<div class="credit-card">`;
                    if (mdPhoto) {
                        html += `<img class="credit-photo" src="${mdPhoto}" alt="${musicDir.name}" onerror="this.style.display='none'">`;
                    } else {
                        html += `<div class="credit-photo-placeholder" style="width:50px;height:50px;font-size:1rem;"><i class="fas fa-headphones"></i></div>`;
                    }
                    html += `
                        <div class="credit-info">
                            <div class="credit-name">${musicDir.name}</div>
                            <div class="credit-role">${musicDir.role || 'Music Director'}</div>
                            ${musicDir.bio ? `<div class="credit-bio">${musicDir.bio}</div>` : ''}
                        </div>
                    </div>`;
                }

                // Lyricist
                if (lyricist && lyricist.name) {
                    const lyrPhoto = lyricist.photo_base64 || null;
                    html += `<div class="credit-card">`;
                    if (lyrPhoto) {
                        html += `<img class="credit-photo" src="${lyrPhoto}" alt="${lyricist.name}" onerror="this.style.display='none'">`;
                    } else {
                        html += `<div class="credit-photo-placeholder" style="width:50px;height:50px;font-size:1rem;"><i class="fas fa-pen"></i></div>`;
                    }
                    html += `
                        <div class="credit-info">
                            <div class="credit-name">${lyricist.name}</div>
                            <div class="credit-role">${lyricist.role || 'Lyricist'}</div>
                            ${lyricist.bio ? `<div class="credit-bio">${lyricist.bio}</div>` : ''}
                        </div>
                    </div>`;
                }

                html += `</div>`;
            }

            // Movie info
            if (data.movie) {
                html += `
                    <div class="movie-info">
                        <i class="fas fa-film"></i>
                        <span>${data.movie}${data.year ? ` (${data.year})` : ''}</span>
                    </div>
                `;
                // Show extra movie info if available
                if (data.movie_info) {
                    html += `
                        <div class="source-info-detail">
                            <small>${data.movie_info}</small>
                        </div>
                    `;
                }
            }

            content.innerHTML = html;
        }

        // Reset song info when song changes
        function resetSongInfo() {
            isSongInfoExpanded = false;
            isSongInfoLoading = false;
            const section = document.getElementById('songInfoSection');
            const content = document.getElementById('songInfoContent');
            if (section) section.classList.remove('expanded');
            if (content) content.innerHTML = '';
        }

        // Set default video mode from settings dialog
        function setDefaultVideoMode(useVideo) {
            isVideoMode = useVideo;
            saveVideoSettings();

            // Update button states
            const audioBtn = document.getElementById('settingsAudioModeBtn');
            const videoBtn = document.getElementById('settingsVideoModeBtn');

            if (audioBtn && videoBtn) {
                audioBtn.classList.toggle('active', !useVideo);
                videoBtn.classList.toggle('active', useVideo);
            }

            // Apply to current playback if a song is playing
            if (hasVideoStream) {
                applyPlaybackMode();

                // Update video toggle button
                const mainVideoBtn = document.getElementById('videoModeBtn');
                if (mainVideoBtn) {
                    mainVideoBtn.classList.toggle('active', useVideo);
                    mainVideoBtn.style.opacity = useVideo ? '1' : '0.6';
                }
            }
        }

        // Set default quality from settings dialog
        function setDefaultQuality(quality) {
            preferredQuality = quality;
            saveVideoSettings();
            console.log('Default quality set to:', quality);
        }

        // Update video settings UI when dialog opens
        function updateVideoSettingsUI() {
            const audioBtn = document.getElementById('settingsAudioModeBtn');
            const videoBtn = document.getElementById('settingsVideoModeBtn');
            const qualitySelect = document.getElementById('settingsQualitySelect');

            if (audioBtn && videoBtn) {
                audioBtn.classList.toggle('active', !isVideoMode);
                videoBtn.classList.toggle('active', isVideoMode);
            }

            if (qualitySelect) {
                qualitySelect.value = preferredQuality;
            }
        }

        // Initialize Video.js player on page load
        document.addEventListener('DOMContentLoaded', function () {
            player = videojs('videoPlayer', {
                controls: false,  // We use custom UI
                autoplay: false,
                preload: 'auto',
                fluid: false,
                techOrder: ['html5'],
                html5: {
                    vhs: {
                        overrideNative: true
                    },
                    nativeAudioTracks: false,
                    nativeVideoTracks: false
                }
            });

            // Attach event listeners
            player.on('loadedmetadata', function () {
                const duration = player.duration();
                document.getElementById('duration').textContent = formatTime(duration);
                // Sync inline controls
                const inlineDuration = document.getElementById('inlineDuration');
                if (inlineDuration) inlineDuration.textContent = formatTime(duration);
            });

            player.on('timeupdate', function () {
                const currentTime = player.currentTime();
                const duration = player.duration();

                if (duration > 0) {
                    const progressPercent = (currentTime / duration) * 100;
                    document.getElementById('progressBar').style.width = progressPercent + '%';
                    document.getElementById('currentTime').textContent = formatTime(currentTime);

                    // Sync inline controls
                    const inlineProgress = document.getElementById('inlineProgress');
                    const inlineCurrentTime = document.getElementById('inlineCurrentTime');
                    if (inlineProgress) inlineProgress.style.width = progressPercent + '%';
                    if (inlineCurrentTime) inlineCurrentTime.textContent = formatTime(currentTime);
                }

                // Also update video overlay controls
                updateVideoOverlay();
            });

            player.on('progress', function () {
                const buffered = player.buffered();
                const duration = player.duration();

                if (buffered.length > 0 && duration > 0) {
                    const bufferedEnd = buffered.end(buffered.length - 1);
                    const bufferedPercent = (bufferedEnd / duration) * 100;
                    document.getElementById('bufferedBar').style.width = bufferedPercent + '%';

                    // Sync inline buffered bar
                    const inlineBuffered = document.getElementById('inlineBufferedBar');
                    if (inlineBuffered) inlineBuffered.style.width = bufferedPercent + '%';
                }
            });

            player.on('ended', function () {
                nextSong();
            });

            player.on('error', function () {
                console.error('Video.js playback error:', player.error());
                document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
                isPlaying = false;
            });

            player.on('play', function () {
                isPlaying = true;
                document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-pause"></i>';
                document.getElementById('albumDisk').classList.add('playing');
                // Sync inline play button
                const inlinePlayBtn = document.getElementById('inlinePlayPauseBtn');
                if (inlinePlayBtn) inlinePlayBtn.innerHTML = '<i class="fas fa-pause"></i>';
                updateVideoOverlay();  // Update video overlay play icon
            });

            player.on('pause', function () {
                isPlaying = false;
                document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
                document.getElementById('albumDisk').classList.remove('playing');
                // Sync inline play button
                const inlinePlayBtn = document.getElementById('inlinePlayPauseBtn');
                if (inlinePlayBtn) inlinePlayBtn.innerHTML = '<i class="fas fa-play"></i>';
                updateVideoOverlay();  // Update video overlay play icon
            });

            // ============================================
            // Video Controls Auto-Hide (YouTube-like)
            // ============================================
            const videoContainer = document.getElementById('expandedVideoContainer');
            const videoOverlay = document.getElementById('videoControlsOverlay');
            let videoControlsTimeout = null;

            // Show controls and reset timer
            function showVideoControls() {
                if (!videoOverlay) return;
                videoOverlay.classList.add('visible');

                // Clear existing timeout
                if (videoControlsTimeout) {
                    clearTimeout(videoControlsTimeout);
                }

                // Hide after 3 seconds
                videoControlsTimeout = setTimeout(() => {
                    hideVideoControls();
                }, 3000);
            }

            // Hide controls
            function hideVideoControls() {
                if (!videoOverlay) return;
                videoOverlay.classList.remove('visible');
            }

            // Add event listeners for video container
            if (videoContainer) {
                // Touch/click to show controls
                videoContainer.addEventListener('click', showVideoControls);
                videoContainer.addEventListener('touchstart', showVideoControls);

                // Keep controls visible while interacting with overlay
                if (videoOverlay) {
                    videoOverlay.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showVideoControls();
                    });
                    videoOverlay.addEventListener('touchstart', (e) => {
                        showVideoControls();
                    });
                }
            }

            // Also add to video player wrapper for collapsed view
            const videoPlayerWrapper = document.getElementById('videoPlayerWrapper');
            if (videoPlayerWrapper) {
                videoPlayerWrapper.addEventListener('click', showVideoControls);
                videoPlayerWrapper.addEventListener('touchstart', showVideoControls);
            }
        });

        // Tab Navigation
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');

                if (tab.dataset.tab === 'playlists') loadPlaylists();
                if (tab.dataset.tab === 'history') loadHistory();
                if (tab.dataset.tab === 'user') checkAuth();
            });
        });

        // View Toggle
        function setView(view) {
            currentView = view;

            // Update all view buttons (both in dialog and any other locations)
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Add active class to clicked button and corresponding button in dialog
            if (event && event.target) {
                event.target.classList.add('active');
            }

            // Also update the other set of buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                const btnText = btn.textContent.toLowerCase();
                if ((view === 'list' && btnText.includes('list')) ||
                    (view === 'grid' && btnText.includes('grid'))) {
                    btn.classList.add('active');
                }
            });

            const listView = document.getElementById('songsList');
            const gridView = document.getElementById('songsGrid');

            if (view === 'list') {
                listView.classList.add('active');
                gridView.classList.remove('active');
            } else {
                listView.classList.remove('active');
                gridView.classList.add('active');
            }

            // Scroll to top when switching views
            document.querySelector('.container').scrollTop = 0;

            // Close settings dialog after selection
            setTimeout(() => {
                closeSettingsDialog();
            }, 300);
        }

        // Search Songs
        async function searchSongs() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            // Reset state for new search
            currentSearchQuery = query;
            currentContinuation = null;
            hasMoreResults = true;
            isLoadingMore = false;

            const listContainer = document.getElementById('songsList');
            const gridContainer = document.getElementById('songsGrid');

            listContainer.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
            gridContainer.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';

            try {
                // Fetch initial results with pagination support
                const response = await fetch(`${API_BASE}/music/search?query=${encodeURIComponent(query)}&limit=${SONGS_PER_PAGE}`);
                const data = await response.json();

                const songs = data.results || data; // Handle both old and new response format
                currentContinuation = data.continuation || null;
                currentPlaylist = songs;

                console.log('Search completed:', {
                    resultsCount: songs.length,
                    hasContinuation: !!currentContinuation,
                    continuationToken: currentContinuation ? 'Available' : 'None'
                });

                // Clear containers
                listContainer.innerHTML = '';
                gridContainer.innerHTML = '';

                // Display results
                displaySongs(songs);

                // Add loading indicator if more results available
                if (currentContinuation) {
                    addLoadingIndicator();
                } else {
                    hasMoreResults = false;
                    addEndMessage();
                }

            } catch (error) {
                console.error('Search error:', error);
                listContainer.innerHTML = '<div class="loading">Error loading songs. Please try again.</div>';
                gridContainer.innerHTML = '<div class="loading">Error loading songs. Please try again.</div>';
            }
        }

        // Display songs in list and grid
        function displaySongs(songs) {
            const listContainer = document.getElementById('songsList');
            const gridContainer = document.getElementById('songsGrid');

            // Remove existing loading indicators
            const existingIndicators = document.querySelectorAll('#loadingIndicator, .end-of-results');
            existingIndicators.forEach(ind => ind.remove());

            const currentIndex = currentPlaylist.length - songs.length;

            // Add songs to view
            songs.forEach((song, index) => {
                const globalIndex = currentIndex + index;

                // Add to list view
                const listItem = createSongListItem(song, globalIndex);
                listContainer.appendChild(listItem);

                // Add to grid view
                const card = createSongCard(song, globalIndex);
                gridContainer.appendChild(card);
            });

            console.log(`Displayed ${songs.length} songs. Total in playlist: ${currentPlaylist.length}`);
        }

        // Add loading indicator
        function addLoadingIndicator() {
            const listContainer = document.getElementById('songsList');
            const gridContainer = document.getElementById('songsGrid');

            // Remove old indicators first
            const oldIndicators = document.querySelectorAll('#loadingIndicator, .end-of-results');
            oldIndicators.forEach(ind => ind.remove());

            const loadingDivList = document.createElement('div');
            loadingDivList.id = 'loadingIndicator';
            loadingDivList.className = 'loading-spinner';
            loadingDivList.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scroll for more...';
            loadingDivList.style.display = 'none';

            const loadingDivGrid = document.createElement('div');
            loadingDivGrid.id = 'loadingIndicator';
            loadingDivGrid.className = 'loading-spinner';
            loadingDivGrid.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scroll for more...';
            loadingDivGrid.style.display = 'none';

            listContainer.appendChild(loadingDivList);
            gridContainer.appendChild(loadingDivGrid);
        }

        // Add end message
        function addEndMessage() {
            const listContainer = document.getElementById('songsList');
            const gridContainer = document.getElementById('songsGrid');

            // Remove old indicators first
            const oldIndicators = document.querySelectorAll('#loadingIndicator, .end-of-results');
            oldIndicators.forEach(ind => ind.remove());

            const endDivList = document.createElement('div');
            endDivList.className = 'end-of-results';
            endDivList.innerHTML = '<i class="fas fa-check-circle"></i> All results loaded';

            const endDivGrid = document.createElement('div');
            endDivGrid.className = 'end-of-results';
            endDivGrid.innerHTML = '<i class="fas fa-check-circle"></i> All results loaded';

            listContainer.appendChild(endDivList);
            gridContainer.appendChild(endDivGrid);
        }

        // Load more songs when scrolling
        async function loadMoreSongs() {
            if (isLoadingMore || !hasMoreResults || !currentContinuation || !currentSearchQuery) {
                return;
            }

            console.log('Loading more songs...', {
                currentPlaylist: currentPlaylist.length,
                hasContinuation: !!currentContinuation
            });

            isLoadingMore = true;

            // Show loading indicator
            const indicators = document.querySelectorAll('#loadingIndicator');
            indicators.forEach(indicator => {
                indicator.style.display = 'block';
                indicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading more...';
            });

            try {
                // Fetch next page using continuation token
                const response = await fetch(
                    `${API_BASE}/music/search?query=${encodeURIComponent(currentSearchQuery)}&limit=${SONGS_PER_PAGE}&continuation=${encodeURIComponent(currentContinuation)}`
                );
                const data = await response.json();

                const newSongs = data.results || data;
                currentContinuation = data.continuation || null;

                // Add to playlist
                currentPlaylist = currentPlaylist.concat(newSongs);

                // Display new songs
                displaySongs(newSongs);

                console.log('Loaded more songs:', {
                    newSongsCount: newSongs.length,
                    totalNow: currentPlaylist.length,
                    hasMore: !!currentContinuation
                });

                // Update state
                if (currentContinuation) {
                    addLoadingIndicator();
                } else {
                    hasMoreResults = false;
                    addEndMessage();
                }

            } catch (error) {
                console.error('Error loading more songs:', error);
                indicators.forEach(indicator => {
                    indicator.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error loading more';
                });
            } finally {
                isLoadingMore = false;
            }
        }

        // Create Song List Item
        function createSongListItem(song, index) {
            const item = document.createElement('div');
            item.className = 'song-item';
            item.innerHTML = `
                <img src="${song.thumbnail || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'}" alt="${song.title}" />
                <div class="song-item-info">
                    <div class="song-item-title">${song.title}</div>
                    <div class="song-item-artist">${song.artist}${song.album ? '  ' + song.album : ''}</div>
                </div>
                <span class="song-item-duration">${formatDuration(song.duration)}</span>
                <button class="song-item-play" onclick='playSongByIndex(${index})'><i class="fas fa-play"></i></button>
            `;
            return item;
        }

        // Create Song Card
        function createSongCard(song, index) {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <img src="${song.thumbnail || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'}" alt="${song.title}" />
                <h3>${song.title}</h3>
                <p>${song.artist}</p>
                ${song.album ? `<p>${song.album}</p>` : ''}
                <p>${formatDuration(song.duration)}</p>
                <div class="card-actions">
                    <button class="btn btn-primary" onclick='playSongByIndex(${index})'><i class="fas fa-play"></i> Play</button>
                    ${token ? `<button class="btn" onclick='addToPlaylist("${song.video_id}")'><i class="fas fa-plus"></i> Add to Playlist</button>` : ''}
                </div>
            `;
            return card;
        }

        // Play Song by Index
        function playSongByIndex(index) {
            currentSongIndex = index;
            playSong(currentPlaylist[index]);
        }

        // Play Song with Video.js and instant feedback
        async function playSong(song) {
            try {
                // Reset song info panel when playing new song
                resetSongInfo();

                // Show loading state immediately
                document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                // Update UI immediately for instant feedback
                document.getElementById('currentSongTitle').textContent = song.title;
                document.getElementById('currentSongArtist').textContent = song.artist;
                document.getElementById('albumArt').src = song.thumbnail || 'https://via.placeholder.com/120';
                document.getElementById('albumDisk').classList.add('playing');

                // Sync video mode song info
                document.getElementById('videoSongTitle').textContent = song.title;
                document.getElementById('videoSongArtist').textContent = song.artist;

                // Reset progress bars
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('bufferedBar').style.width = '0%';
                document.getElementById('currentTime').textContent = '0:00';

                // Store current video ID and enable expand button
                currentVideoId = song.video_id;
                document.getElementById('musicPlayer').classList.add('has-song');

                // Load stream info from backend
                const infoResp = await fetch(`${API_BASE}/music/stream/info/${song.video_id}`);
                const streamInfo = await infoResp.json();
                currentStreamInfo = streamInfo;

                console.log('StreamInfo:', streamInfo);


                // Check if video stream is available
                hasVideoStream = streamInfo.has_video === true;

                // Populate available qualities from backend                
                if (streamInfo.qualities && streamInfo.qualities.length > 0) {
                    availableQualities = streamInfo.qualities;
                    currentQuality = streamInfo.default_quality || 'audio_only';
                } else {
                    // Fallback: create basic quality array
                    availableQualities = [{
                        quality_id: 'audio_only',
                        label: 'Audio Only',
                        url: streamInfo.url,
                        mime_type: streamInfo.mime_type,
                        is_video: false,
                        height: 0
                    }];

                    if (hasVideoStream && streamInfo.video_url) {
                        availableQualities.push({
                            quality_id: `${streamInfo.video_height || 'video'}p`,
                            label: `${streamInfo.video_height || 'Video'}p`,
                            url: streamInfo.video_url,
                            mime_type: streamInfo.video_mime_type,
                            is_video: true,
                            height: streamInfo.video_height || 0
                        });
                    }

                    currentQuality = 'audio_only';
                }

                console.log('Available qualities:', availableQualities.map(q => q.label));

                // Update video toggle button visibility based on video availability
                const videoBtn = document.getElementById('videoModeBtn');
                if (hasVideoStream) {
                    videoBtn.style.opacity = '1';
                    videoBtn.disabled = false;
                    videoBtn.title = 'Toggle Video Mode';

                    // Apply saved video mode preference if user prefers video
                    if (isVideoMode) {
                        // Find preferred quality or nearest
                        const videoQualities = availableQualities.filter(q => q.is_video);
                        let targetQuality = videoQualities.find(q => q.quality_id === preferredQuality);

                        if (!targetQuality && videoQualities.length > 0) {
                            const preferredHeight = parseInt(preferredQuality) || 480;
                            targetQuality = videoQualities.reduce((prev, curr) => {
                                const prevDiff = Math.abs((prev?.height || 0) - preferredHeight);
                                const currDiff = Math.abs((curr.height || 0) - preferredHeight);
                                return currDiff < prevDiff ? curr : prev;
                            }, videoQualities[0]);
                        }

                        if (targetQuality) {
                            currentQuality = targetQuality.quality_id;
                        }

                        // Update button style to show active state
                        videoBtn.classList.add('active');
                    } else {
                        videoBtn.classList.remove('active');
                    }
                } else {
                    videoBtn.style.opacity = '0.3';
                    videoBtn.disabled = true;
                    videoBtn.title = 'No video available';
                    isVideoMode = false;  // Force audio-only mode if no video
                }

                // Determine which stream URL to use based on current mode
                let streamUrl = `${API_BASE}/music/stream/proxy/${song.video_id}`;
                let mimeType = streamInfo.mime_type || 'audio/webm';

                // If in video mode and video stream is available, use video URL
                if (isVideoMode && hasVideoStream && streamInfo.video_url) {
                    streamUrl = streamInfo.video_url;  // Use actual video stream URL
                    mimeType = streamInfo.video_mime_type || 'video/mp4';
                }

                // Load stream into Video.js
                player.src({
                    src: streamUrl,
                    type: mimeType
                });

                // Apply current playback mode (audio-only or video)
                applyPlaybackMode();

                // Play
                try {
                    await player.play();
                } catch (playError) {
                    console.error('Autoplay error:', playError);
                    // Autoplay blocked - user will need to click play
                    document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
                    isPlaying = false;
                }

                // Load video details in background (if player is expanded)
                if (isPlayerExpanded) {
                    setTimeout(() => loadVideoDetails(song.video_id), 500);
                }
            } catch (error) {
                console.error('Error playing song:', error);
                alert('Error playing song. Please try again.');
                document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
                isPlaying = false;
            }
        }

        // Toggle Video Mode (Audio-only vs Video)
        function toggleVideoMode() {
            if (!hasVideoStream) return;  // Can't toggle if no video available

            const wasAudioMode = !isVideoMode;
            isVideoMode = !isVideoMode;
            applyPlaybackMode();

            // Update button style
            const videoBtn = document.getElementById('videoModeBtn');
            videoBtn.style.opacity = isVideoMode ? '1' : '0.6';
            videoBtn.classList.toggle('active', isVideoMode);

            // Auto-expand player when switching from audio to video mode only
            if (wasAudioMode && isVideoMode && !isPlayerExpanded) {
                togglePlayerExpand();
            }
        }

        // Apply Playback Mode (show/hide video vs CD disc)
        function applyPlaybackMode() {
            const cdDisc = document.getElementById('albumDisk');
            const videoWrapper = document.getElementById('videoPlayerWrapper');
            const videoElement = document.getElementById('videoPlayer');
            const playerEl = document.getElementById('musicPlayer');

            if (isVideoMode && hasVideoStream) {
                // Video mode: show video, hide disc
                cdDisc.style.display = 'none';
                videoWrapper.classList.add('video-mode');

                // Move video element to wrapper if not already there
                if (videoElement.parentElement !== videoWrapper) {
                    videoWrapper.appendChild(videoElement);
                }

                // If player is expanded, handle video expansion
                if (isPlayerExpanded) {
                    handleVideoExpansion(true);
                }
            } else {
                // Audio-only mode: hide video, show disc
                cdDisc.style.display = 'flex';
                videoWrapper.classList.remove('video-mode');

                // Remove video-mode-expanded class in audio mode
                playerEl.classList.remove('video-mode-expanded');

                // If player is expanded and we switched to audio mode, collapse video container
                if (isPlayerExpanded) {
                    const expandedContainer = document.getElementById('expandedVideoContainer');
                    expandedContainer.style.display = 'none';
                    expandedContainer.classList.remove('active');
                }
            }

            // Update video center play button icon
            updateVideoOverlay();
        }

        // Toggle Fullscreen for video player
        function toggleFullscreen() {
            const videoContainer = document.getElementById('expandedVideoContainer');
            const fullscreenBtn = document.getElementById('fullscreenBtn');

            if (!videoContainer) return;

            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
                // Enter fullscreen
                if (videoContainer.requestFullscreen) {
                    videoContainer.requestFullscreen();
                } else if (videoContainer.webkitRequestFullscreen) {
                    videoContainer.webkitRequestFullscreen();
                } else if (videoContainer.msRequestFullscreen) {
                    videoContainer.msRequestFullscreen();
                }

                // Update icon to compress
                if (fullscreenBtn) {
                    fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                    fullscreenBtn.title = 'Exit Fullscreen';
                }
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }

                // Update icon to expand
                if (fullscreenBtn) {
                    fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                    fullscreenBtn.title = 'Fullscreen';
                }
            }
        }

        // Listen for fullscreen change to update button icon
        document.addEventListener('fullscreenchange', updateFullscreenButton);
        document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
        document.addEventListener('msfullscreenchange', updateFullscreenButton);

        function updateFullscreenButton() {
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            if (!fullscreenBtn) return;

            if (document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement) {
                fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                fullscreenBtn.title = 'Exit Fullscreen';
            } else {
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                fullscreenBtn.title = 'Fullscreen';
            }
        }

        // Toggle Quality Menu
        function toggleQualityMenu(event) {
            if (event) event.stopPropagation();

            qualityMenuVisible = !qualityMenuVisible;
            const menu = document.getElementById('qualityMenu');

            if (qualityMenuVisible) {
                renderQualityOptions();
                menu.classList.add('visible');
            } else {
                menu.classList.remove('visible');
            }
        }

        // Render Quality Options
        function renderQualityOptions() {
            const container = document.getElementById('qualityOptions');
            container.innerHTML = '';

            if (availableQualities.length === 0) {
                container.innerHTML = '<div class="quality-option" style="color: #888;">No options available</div>';
                return;
            }

            availableQualities.forEach(quality => {
                const option = document.createElement('div');
                option.className = 'quality-option' + (quality.quality_id === currentQuality ? ' active' : '');
                option.innerHTML = `
                    <span>${quality.label}</span>
                    ${quality.quality_id === currentQuality ? '<i class="fas fa-check checkmark"></i>' : ''}
                `;
                option.onclick = (e) => {
                    e.stopPropagation();
                    switchQuality(quality.quality_id);
                };
                container.appendChild(option);
            });
        }

        // Switch Quality with Smooth Transition
        async function switchQuality(qualityId) {
            if (qualityId === currentQuality) {
                toggleQualityMenu();
                return;
            }

            const quality = availableQualities.find(q => q.quality_id === qualityId);
            if (!quality || !quality.url) {
                console.error('Quality not found or no URL:', qualityId);
                return;
            }

            try {
                // Save current playback state
                const currentTime = player.currentTime();
                const wasPlaying = !player.paused();

                // Show loading state
                document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                console.log(`Switching quality to ${qualityId} at ${formatTime(currentTime)}`);

                // Build proxied URL to bypass CORS
                let streamUrl;
                if (quality.is_video) {
                    // Video qualities need to be proxied through backend
                    const encodedUrl = encodeURIComponent(quality.url);
                    streamUrl = `${API_BASE}/music/stream/proxy/${currentVideoId}?quality_url=${encodedUrl}`;
                } else {
                    // Audio-only uses the default proxy
                    streamUrl = `${API_BASE}/music/stream/proxy/${currentVideoId}`;
                }

                // Load new quality stream through proxy
                player.src({
                    src: streamUrl,
                    type: quality.mime_type
                });

                // Wait for metadata to load then restore position
                player.one('loadedmetadata', async () => {
                    try {
                        // Restore playback position
                        player.currentTime(currentTime);

                        // Update state
                        currentQuality = qualityId;
                        isVideoMode = quality.is_video;

                        // Apply visual mode
                        applyPlaybackMode();

                        // Update button states
                        const videoBtn = document.getElementById('videoModeBtn');
                        videoBtn.style.opacity = isVideoMode ? '1' : '0.6';
                        videoBtn.classList.toggle('active', isVideoMode);

                        // Resume playback if was playing
                        if (wasPlaying) {
                            await player.play();
                        }

                        console.log(`Quality switched to ${qualityId} successfully`);
                    } catch (e) {
                        console.error('Error restoring playback:', e);
                    }
                });

                // Close quality menu
                toggleQualityMenu();

            } catch (error) {
                console.error('Quality switch error:', error);
                document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
            }
        }

        // Enhanced toggleVideoMode - use quality switching for smooth transition
        function toggleVideoMode() {
            if (!hasVideoStream) return;

            const wasAudioMode = !isVideoMode;

            // Auto-expand player FIRST when switching from audio to video mode
            if (wasAudioMode && !isPlayerExpanded) {
                togglePlayerExpand();
            }

            // Find target quality based on current mode
            let targetQuality;
            if (isVideoMode) {
                // Currently video, switch to audio
                targetQuality = availableQualities.find(q => !q.is_video);
            } else {
                // Currently audio, switch to video - try to use preferred quality first
                const videoQualities = availableQualities.filter(q => q.is_video);

                // Try preferred quality first
                targetQuality = videoQualities.find(q => q.quality_id === preferredQuality);

                // If preferred not available, use nearest quality
                if (!targetQuality) {
                    const preferredHeight = parseInt(preferredQuality) || 480;
                    targetQuality = videoQualities.reduce((prev, curr) => {
                        const prevDiff = Math.abs((prev?.height || 0) - preferredHeight);
                        const currDiff = Math.abs((curr.height || 0) - preferredHeight);
                        return currDiff < prevDiff ? curr : prev;
                    }, videoQualities[0]);
                }

                // Fallback to highest quality
                if (!targetQuality) {
                    targetQuality = videoQualities[videoQualities.length - 1];
                }
            }

            if (targetQuality) {
                switchQuality(targetQuality.quality_id);
            } else {
                // Fallback: just toggle visual mode
                isVideoMode = !isVideoMode;
                applyPlaybackMode();

                const videoBtn = document.getElementById('videoModeBtn');
                videoBtn.style.opacity = isVideoMode ? '1' : '0.6';
            }

            // Save video mode preference to localStorage
            saveVideoSettings();
        }

        // Seek in video overlay progress bar
        function seekToVideo(event) {
            if (!player) return;

            const bar = event.currentTarget;
            const rect = bar.getBoundingClientRect();
            const percent = Math.max(0, Math.min(1, (event.clientX - rect.left) / rect.width));
            const duration = player.duration();

            if (duration > 0) {
                player.currentTime(percent * duration);
            }
        }

        // Update video overlay controls (called on timeupdate)
        function updateVideoOverlay() {
            if (!player) return;

            const currentTime = player.currentTime();
            const duration = player.duration();

            // Update progress fill
            const progressFill = document.getElementById('videoOverlayProgress');
            if (progressFill && duration > 0) {
                progressFill.style.width = ((currentTime / duration) * 100) + '%';
            }

            // Update time display
            const timeDisplay = document.getElementById('videoTimeDisplay');
            if (timeDisplay) {
                timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
            }

            // Update center play icon
            const centerIcon = document.getElementById('videoCenterPlayIcon');
            if (centerIcon) {
                centerIcon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
            }
        }

        // Close quality menu when clicking outside
        document.addEventListener('click', (e) => {
            if (qualityMenuVisible) {
                const menu = document.getElementById('qualityMenu');
                const settingsBtn = document.querySelector('.video-settings-btn');
                if (!menu.contains(e.target) && !settingsBtn?.contains(e.target)) {
                    toggleQualityMenu();
                }
            }
        });

        // Toggle Play/Pause (Video.js)
        function togglePlay() {
            if (!player || !player.src()) return;

            if (isPlaying) {
                player.pause();
            } else {
                player.play();
            }
        }

        // Stop Song (Video.js)
        function stopSong() {
            if (!player) return;
            player.pause();
            player.currentTime(0);
            document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
            document.getElementById('albumDisk').classList.remove('playing');
            isPlaying = false;
        }

        // Next/Previous Song
        function nextSong() {
            if (currentPlaylist.length === 0) return;

            switch (playbackMode) {
                case 'shuffle':
                    // Random song (excluding current)
                    let newIndex = currentSongIndex;
                    while (newIndex === currentSongIndex && currentPlaylist.length > 1) {
                        newIndex = Math.floor(Math.random() * currentPlaylist.length);
                    }
                    currentSongIndex = newIndex;
                    break;
                case 'repeat':
                    // Repeat current song - stay on same index
                    break;
                case 'loop':
                    // Loop all - wrap around
                    currentSongIndex = (currentSongIndex + 1) % currentPlaylist.length;
                    break;
                default: // 'off'
                    // Normal sequential - stop at end
                    if (currentSongIndex < currentPlaylist.length - 1) {
                        currentSongIndex++;
                    } else {
                        // Reached end - optionally stop or loop
                        currentSongIndex = 0; // Loop to beginning
                    }
            }
            playSong(currentPlaylist[currentSongIndex]);
        }

        function previousSong() {
            if (currentPlaylist.length === 0) return;
            currentSongIndex = currentSongIndex - 1;
            if (currentSongIndex < 0) currentSongIndex = currentPlaylist.length - 1;
            playSong(currentPlaylist[currentSongIndex]);
        }

        // Playback Mode Toggle: off  shuffle  loop  repeat  off
        // Icons: fa-random (shuffle), fa-redo (loop), fa-redo-alt (repeat one)
        function toggleShuffle() {
            // Cycle through modes
            const modes = ['off', 'shuffle', 'loop', 'repeat'];
            const currentIndex = modes.indexOf(playbackMode);
            playbackMode = modes[(currentIndex + 1) % modes.length];

            updatePlaybackModeUI();
            console.log('Playback mode:', playbackMode);
        }

        // Update button icons and opacity based on current mode
        function updatePlaybackModeUI() {
            const shuffleBtn = document.getElementById('shuffleBtn');
            const inlineShuffleBtn = document.getElementById('inlineShuffleBtn');

            let icon, title, opacity;

            switch (playbackMode) {
                case 'shuffle':
                    icon = 'fa-random';
                    title = 'Shuffle (click for Loop All)';
                    opacity = '1';
                    break;
                case 'loop':
                    icon = 'fa-redo';
                    title = 'Loop All (click for Repeat One)';
                    opacity = '1';
                    break;
                case 'repeat':
                    icon = 'fa-sync';
                    title = 'Repeat One (click to turn Off)';
                    opacity = '1';
                    break;
                default: // 'off'
                    icon = 'fa-random';
                    title = 'Playback Mode: Off (click for Shuffle)';
                    opacity = '0.5';
            }

            // Update main button
            if (shuffleBtn) {
                shuffleBtn.innerHTML = `<i class="fas ${icon}"></i>`;
                shuffleBtn.style.opacity = opacity;
                shuffleBtn.title = title;
            }

            // Update inline button
            if (inlineShuffleBtn) {
                inlineShuffleBtn.innerHTML = `<i class="fas ${icon}"></i>`;
                inlineShuffleBtn.style.opacity = opacity;
                inlineShuffleBtn.title = title;
            }

            // Update overlay button (video overlay)
            const overlayShuffleBtn = document.getElementById('overlayShuffleBtn');
            if (overlayShuffleBtn) {
                overlayShuffleBtn.innerHTML = `<i class="fas ${icon}"></i>`;
                overlayShuffleBtn.style.opacity = opacity;
                overlayShuffleBtn.title = title;
            }
        }

        // Improved seeking with visual feedback (Desktop + Mobile) - Video.js
        function seekTo(event) {
            event.preventDefault(); // Prevent default touch behavior
            if (!player) return;

            const bar = event.currentTarget || document.querySelector('.progress-bar');
            const rect = bar.getBoundingClientRect();

            // Support both mouse and touch events
            const clientX = event.clientX || (event.touches && event.touches[0].clientX) ||
                (event.changedTouches && event.changedTouches[0].clientX);

            if (!clientX) return;

            const duration = player.duration();
            const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
            const newTime = percent * duration;

            if (!isNaN(newTime) && isFinite(newTime) && duration > 0) {
                player.currentTime(newTime);
                // Update progress bar immediately for instant feedback
                document.getElementById('progressBar').style.width = (percent * 100) + '%';
                console.log(`Seeked to ${formatTime(newTime)} (${(percent * 100).toFixed(1)}%)`);
            }
        }

        // Add drag support for seeking (Desktop + Mobile)
        let isDragging = false;
        const progressBar = document.querySelector('.progress-bar');

        // Desktop - Mouse events
        progressBar.addEventListener('mousedown', (e) => {
            isDragging = true;
            seekTo(e);
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                seekTo(e);
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });

        // Mobile - Touch events
        progressBar.addEventListener('touchstart', (e) => {
            isDragging = true;
            seekTo(e);
        }, { passive: false });

        progressBar.addEventListener('touchmove', (e) => {
            if (isDragging) {
                seekTo(e);
            }
        }, { passive: false });

        progressBar.addEventListener('touchend', () => {
            isDragging = false;
        });

        progressBar.addEventListener('touchcancel', () => {
            isDragging = false;
        });

        // Format Time
        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function formatDuration(seconds) {
            if (!seconds) return '--:--';
            return formatTime(seconds);
        }

        // Authentication
        function checkAuth() {
            if (token) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('userInfo').style.display = 'block';
                loadUserInfo();
            } else {
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('userInfo').style.display = 'none';
            }
        }

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                alert('Please enter username and password');
                return;
            }

            const formData = new FormData();
            formData.append('username', username);
            formData.append('password', password);

            try {
                const response = await fetch(`${API_BASE}/user/login`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    token = data.access_token;
                    localStorage.setItem('token', token);
                    checkAuth();
                } else {
                    alert('Login failed. Please check your credentials.');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login error. Please try again.');
            }
        }

        function logout() {
            token = null;
            localStorage.removeItem('token');
            checkAuth();
        }

        async function loadUserInfo() {
            try {
                const response = await fetch(`${API_BASE}/user/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to load user info');
                }

                const user = await response.json();
                document.getElementById('userUsername').textContent = user.username;
                document.getElementById('userEmail').textContent = user.email;
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        function showSignup() {
            alert('Signup feature coming soon! Please contact admin for account creation.');
        }

        // Playlists
        function showCreatePlaylistModal() {
            if (!token) {
                alert('Please login to create playlists');
                return;
            }
            document.getElementById('createPlaylistModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('createPlaylistModal').classList.remove('active');
        }

        async function createPlaylist() {
            const name = document.getElementById('playlistName').value;
            const description = document.getElementById('playlistDescription').value;

            if (!name) {
                alert('Please enter a playlist name');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/playlist/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name, description })
                });

                if (response.ok) {
                    document.getElementById('playlistName').value = '';
                    document.getElementById('playlistDescription').value = '';
                    closeModal();
                    loadPlaylists();
                } else {
                    alert('Failed to create playlist');
                }
            } catch (error) {
                console.error('Error creating playlist:', error);
                alert('Error creating playlist');
            }
        }

        async function loadPlaylists() {
            if (!token) {
                document.getElementById('playlistsGrid').innerHTML = '<div class="loading">Please login to view playlists</div>';
                return;
            }

            document.getElementById('playlistsGrid').innerHTML = '<div class="loading">Loading playlists...</div>';

            try {
                const response = await fetch(`${API_BASE}/playlist/my-playlists`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to load playlists');
                }

                const playlists = await response.json();

                const grid = document.getElementById('playlistsGrid');
                grid.innerHTML = '';

                if (playlists.length === 0) {
                    grid.innerHTML = '<div class="loading">No playlists yet. Create one to get started!</div>';
                    return;
                }

                playlists.forEach(playlist => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <h3>${playlist.name}</h3>
                        <p>${playlist.description || 'No description'}</p>
                        <p><strong>Songs:</strong> ${playlist.songs.length}</p>
                        <p style="font-size: 0.7rem; color: rgba(255,255,255,0.5); margin-top: 8px;">
                            Created: ${new Date(playlist.created_at).toLocaleDateString()}
                        </p>
                    `;
                    grid.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading playlists:', error);
                document.getElementById('playlistsGrid').innerHTML = '<div class="loading">Error loading playlists</div>';
            }
        }

        async function loadHistory() {
            if (!token) {
                document.getElementById('historyList').innerHTML = '<div class="loading">Please login to view history</div>';
                return;
            }

            document.getElementById('historyList').innerHTML = '<div class="loading">Loading history...</div>';

            try {
                const response = await fetch(`${API_BASE}/user/history`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Failed to load history');
                }

                const history = await response.json();

                const list = document.getElementById('historyList');

                if (history.length === 0) {
                    list.innerHTML = '<div class="loading">No listening history yet</div>';
                    return;
                }

                list.innerHTML = '<div class="songs-list active"></div>';
                const container = list.querySelector('.songs-list');

                for (const item of history.slice(0, 50)) {
                    try {
                        const songResponse = await fetch(`${API_BASE}/music/song/${item.video_id}`);
                        if (!songResponse.ok) continue;

                        const song = await songResponse.json();

                        const listItem = document.createElement('div');
                        listItem.className = 'song-item';
                        listItem.innerHTML = `
                            <img src="${song.thumbnail || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'}" alt="${song.title}" />
                            <div class="song-item-info">
                                <div class="song-item-title">${song.title}</div>
                                <div class="song-item-artist">${song.artist}  ${new Date(item.played_at).toLocaleString()}</div>
                            </div>
                            <span class="song-item-duration">${formatDuration(song.duration)}</span>
                            <button class="song-item-play" onclick='playSong(${JSON.stringify(song).replace(/'/g, "\\'")})'><i class="fas fa-play"></i></button>
                        `;
                        container.appendChild(listItem);
                    } catch (err) {
                        console.error('Error loading history item:', err);
                    }
                }
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('historyList').innerHTML = '<div class="loading">Error loading history</div>';
            }
        }

        // Search on Enter
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchSongs();
        });

        // Infinite Scroll - Detect when user scrolls near bottom
        const container = document.querySelector('.container');
        let scrollTimeout;

        container.addEventListener('scroll', () => {
            // Debounce scroll event
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                const scrollTop = container.scrollTop;
                const scrollHeight = container.scrollHeight;
                const clientHeight = container.clientHeight;

                // Load more when user is 300px from bottom
                if (scrollHeight - scrollTop - clientHeight < 300) {
                    loadMoreSongs();
                }
            }, 100);
        });

        // ============================================================================
        // Video Details Panel Functions
        // ============================================================================

        /**
         * Toggle player expand/collapse
         */
        function togglePlayerExpand() {
            const player = document.getElementById('musicPlayer');
            isPlayerExpanded = !isPlayerExpanded;

            if (isPlayerExpanded) {
                player.classList.add('expanded');
                // Load video details if not already loaded
                if (currentVideoId) {
                    loadVideoDetails(currentVideoId);
                }
                // Handle video mode expansion
                handleVideoExpansion(true);
            } else {
                player.classList.remove('expanded');
                // Handle video mode collapse
                handleVideoExpansion(false);
            }
        }

        /**
         * Handle video element positioning when expanding/collapsing player
         */
        function handleVideoExpansion(expand) {
            const expandedContainer = document.getElementById('expandedVideoContainer');
            const videoWrapper = document.getElementById('videoPlayerWrapper');
            const playerContent = document.querySelector('.player-content');
            const albumDisk = document.getElementById('albumDisk');
            const playerEl = document.getElementById('musicPlayer');

            if (expand && isVideoMode && hasVideoStream) {
                // Add video-mode-expanded class for layout reordering
                playerEl.classList.add('video-mode-expanded');

                // Show expanded video container
                expandedContainer.style.display = 'block';
                expandedContainer.classList.add('active');

                // Move video wrapper to expanded container
                if (videoWrapper.parentElement !== expandedContainer) {
                    expandedContainer.appendChild(videoWrapper);
                }

                // Ensure video mode class is set
                videoWrapper.classList.add('video-mode');

                // Update quality menu rendering for expanded view
                renderQualityOptions();

            } else if (!expand) {
                // Remove video-mode-expanded class
                playerEl.classList.remove('video-mode-expanded');

                // Hide expanded container
                expandedContainer.style.display = 'none';
                expandedContainer.classList.remove('active');

                // Move video wrapper back to player content (after album disk)
                if (videoWrapper.parentElement !== playerContent) {
                    // Insert after albumDisk
                    if (albumDisk && albumDisk.nextSibling) {
                        playerContent.insertBefore(videoWrapper, albumDisk.nextSibling);
                    } else {
                        playerContent.appendChild(videoWrapper);
                    }
                }
            } else {
                // Audio mode - make sure video-mode-expanded is removed
                playerEl.classList.remove('video-mode-expanded');
            }
        }

        /**
         * Load video details and comments
         */
        async function loadVideoDetails(videoId) {
            const contentDiv = document.getElementById('videoDetailsContent');

            // Show loading state
            contentDiv.innerHTML = `
                <div class="loading-spinner">
                    <i class="fas fa-spinner"></i>
                    <p>Loading video details...</p>
                </div>
            `;

            try {
                // Fetch video details and comments in one call
                const response = await fetch(`${API_BASE}/youtube/video/${videoId}/full-details?include_comments=true&max_comments=20`);

                if (!response.ok) {
                    throw new Error('Failed to fetch video details');
                }

                const data = await response.json();

                // Render video details
                renderVideoDetails(data.video, data.comments);

            } catch (error) {
                console.error('Error loading video details:', error);
                contentDiv.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load video details. Please check your YouTube API configuration.</p>
                    </div>
                `;
            }
        }

        /**
         * Render video details and comments with expandable sections
         */
        function renderVideoDetails(video, commentsData) {
            const contentDiv = document.getElementById('videoDetailsContent');

            // Format numbers
            const formatNumber = (num) => {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toString();
            };

            // Format date
            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            };

            // Build HTML with expandable sections
            // Video Details expanded by default, Comments and Suggested Songs collapsed

            // Get current song info from main player
            const songTitle = document.getElementById('currentSongTitle').textContent || 'No song playing';
            const songArtist = document.getElementById('currentSongArtist').textContent || 'Select a song to play';

            // Start with song info at top (visible in video mode)
            let html = `
                <div class="video-song-info">
                    <h3 id="videoSongTitle">${songTitle}</h3>
                    <p id="videoSongArtist">${songArtist}</p>
                </div>
            `;

            html += `<div class="expandable-sections-wrapper">`;

            // Video Information - Expandable Section (EXPANDED by default)
            // Stats shown in HEADER (always visible), Description in expandable content
            html += `
                <div class="expandable-section expanded" id="videoDetailsSection">
                    <div class="expandable-header" onclick="toggleSection('videoDetailsSection')">
                        <div class="header-with-stats">
                            <div class="video-stats-inline">
                                <span class="stat-inline"><i class="fas fa-eye"></i> ${formatNumber(video.view_count)}</span>
                                <span class="stat-inline"><i class="fas fa-thumbs-up"></i> ${formatNumber(video.like_count)}</span>
                                <span class="stat-inline"><i class="fas fa-comment"></i> ${formatNumber(video.comment_count)}</span>
                                <span class="stat-inline"><i class="fas fa-calendar"></i> ${formatDate(video.published_at)}</span>
                            </div>
                        </div>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="expandable-content">
                        ${video.description ? `
                            <h4 style="margin-top: 5px; margin-bottom: 10px; font-size: 0.95rem;">Description</h4>
                            <div class="video-description">${escapeHtml(video.description)}</div>
                        ` : '<p style="opacity: 0.7; padding: 10px;">No description available</p>'}
                    </div>
                </div>
            `;

            // Song Info - Expandable Section (collapsed by default, lazy loads when expanded)
            html += `
                <div class="song-info-section" id="songInfoSection">
                    <div class="song-info-header" onclick="toggleSongInfoSection()">
                        <h3><i class="fas fa-user-circle"></i> Song Info</h3>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="song-info-content" id="songInfoContent">
                        <!-- Loaded dynamically when expanded -->
                    </div>
                </div>
            `;

            // Comments - Expandable Section (collapsed by default, scrollable)
            // Header shows first comment preview
            if (commentsData && commentsData.comments && commentsData.comments.length > 0) {
                let commentsHtml = '';
                commentsData.comments.forEach(comment => {
                    commentsHtml += renderComment(comment, formatDate);
                });

                // Get first comment preview (truncate to 80 chars)
                const firstComment = commentsData.comments[0];
                const commentPreview = firstComment.text.length > 80
                    ? firstComment.text.substring(0, 80) + '...'
                    : firstComment.text;

                html += `
                    <div class="expandable-section" id="commentsSection">
                        <div class="expandable-header" onclick="toggleSection('commentsSection')">
                            <div class="header-with-preview">
                                <h3><i class="fas fa-comments"></i> Comments (${commentsData.total_results})</h3>
                                <p class="comment-preview">"${escapeHtml(commentPreview)}"</p>
                            </div>
                            <i class="fas fa-chevron-down toggle-icon"></i>
                        </div>
                        <div class="expandable-content">
                            <div class="comments-container">
                                ${commentsHtml}
                            </div>
                        </div>
                    </div>
                `;
            } else if (commentsData && commentsData.disabled) {
                html += `
                    <div class="expandable-section" id="commentsSection">
                        <div class="expandable-header" onclick="toggleSection('commentsSection')">
                            <div class="header-with-preview">
                                <h3><i class="fas fa-comments"></i> Comments</h3>
                                <p class="comment-preview" style="opacity: 0.6;"><i class="fas fa-ban"></i> Comments disabled</p>
                            </div>
                            <i class="fas fa-chevron-down toggle-icon"></i>
                        </div>
                        <div class="expandable-content">
                            <p style="text-align: center; padding: 20px; opacity: 0.7;">
                                <i class="fas fa-ban"></i> Comments are disabled for this video
                            </p>
                        </div>
                    </div>
                `;
            }

            // Suggested Songs - Plain list (no expandable container)
            html += `
                <div class="suggested-songs-section">
                    <h3 class="section-header"><i class="fas fa-music"></i> Suggested Songs</h3>
                    <div class="suggested-songs-list" id="suggestedSongsList">
                        <p style="text-align: center; padding: 20px; opacity: 0.7;">
                            <i class="fas fa-headphones"></i> Suggested songs coming soon
                        </p>
                    </div>
                </div>
            `;

            html += `</div>`;  // Close expandable-sections-wrapper
            contentDiv.innerHTML = html;
        }

        /**
         * Toggle expand/collapse of a section
         */
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.toggle('expanded');
            }
        }

        /**
         * Render a single comment with replies
         */
        function renderComment(comment, formatDate) {
            let html = `
                <div class="comment">
                    <div class="comment-header">
                        <img src="${comment.author_profile_image || 'https://via.placeholder.com/40'}"
                             alt="${escapeHtml(comment.author)}"
                             class="comment-avatar">
                        <span class="comment-author">${escapeHtml(comment.author)}</span>
                        <span class="comment-date">${formatDate(comment.published_at)}</span>
                    </div>
                    <div class="comment-text">${escapeHtml(comment.text)}</div>
                    <div class="comment-footer">
                        <div class="comment-likes">
                            <i class="fas fa-thumbs-up"></i>
                            <span>${comment.like_count}</span>
                        </div>
                        ${comment.reply_count > 0 ? `
                            <span><i class="fas fa-reply"></i> ${comment.reply_count} ${comment.reply_count === 1 ? 'reply' : 'replies'}</span>
                        ` : ''}
                    </div>
            `;

            // Add replies if available
            if (comment.replies && comment.replies.length > 0) {
                html += '<div class="comment-replies">';
                comment.replies.forEach(reply => {
                    html += `
                        <div class="comment-reply">
                            <div class="comment-header">
                                <img src="${reply.author_profile_image || 'https://via.placeholder.com/40'}"
                                     alt="${escapeHtml(reply.author)}"
                                     class="comment-avatar"
                                     style="width: 32px; height: 32px;">
                                <span class="comment-author">${escapeHtml(reply.author)}</span>
                                <span class="comment-date">${formatDate(reply.published_at)}</span>
                            </div>
                            <div class="comment-text">${escapeHtml(reply.text)}</div>
                            <div class="comment-footer">
                                <div class="comment-likes">
                                    <i class="fas fa-thumbs-up"></i>
                                    <span>${reply.like_count}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        /**
         * Escape HTML to prevent XSS
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Settings Dialog Functions
        function openSettingsDialog() {
            const overlay = document.getElementById('settingsDialog');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scroll

            // Update video settings UI to match current values
            updateVideoSettingsUI();
        }

        function closeSettingsDialog() {
            const overlay = document.getElementById('settingsDialog');
            overlay.classList.remove('active');
            document.body.style.overflow = ''; // Restore scroll
        }

        // Close dialog when clicking overlay
        document.addEventListener('click', (e) => {
            const overlay = document.getElementById('settingsDialog');
            if (e.target === overlay) {
                closeSettingsDialog();
            }
        });

        // Close dialog with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeSettingsDialog();
            }
        });

        // Submit logged cookies to backend
        async function submitLoggedCookies() {
            const statusEl = document.getElementById('loggedCookiesStatus');
            const textarea = document.getElementById('loggedCookiesInput');
            if (!textarea) return;
            const content = textarea.value;
            if (!content || !content.trim()) {
                if (statusEl) { statusEl.textContent = 'Please paste valid cookies content.'; statusEl.style.color = '#ffdddd'; }
                return;
            }
            try {
                if (statusEl) { statusEl.textContent = 'Saving logged cookies...'; statusEl.style.color = '#dddddd'; }
                const res = await fetch(API_BASE + '/cookies/logged', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cookies: content })
                });
                const data = await res.json();
                if (res.ok) {
                    if (statusEl) { statusEl.textContent = 'Logged cookies saved successfully.'; statusEl.style.color = '#d4edda'; }
                } else {
                    if (statusEl) { statusEl.textContent = 'Failed to save: ' + (data.detail || 'Unknown error'); statusEl.style.color = '#ffdddd'; }
                }
            } catch (err) {
                if (statusEl) { statusEl.textContent = 'Network error while saving cookies.'; statusEl.style.color = '#ffdddd'; }
            }
        }

        // Initialize
        checkAuth();
    </script>

    <!-- Settings Dialog -->
    <div id="settingsDialog" class="dialog-overlay">
        <div class="dialog">
            <div class="dialog-header">
                <h2><i class="fas fa-cog"></i> Settings</h2>
                <button class="dialog-close" onclick="closeSettingsDialog()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="dialog-body">
                <!-- View Mode Section -->
                <div class="settings-section">
                    <h3>Display Preferences</h3>
                    <div class="settings-option">
                        <div class="settings-option-label">
                            <i class="fas fa-eye"></i>
                            View Mode
                        </div>
                        <div class="settings-option-description">
                            Choose how you want to view your music library
                        </div>
                        <div class="view-toggle">
                            <button class="view-btn active" onclick="setView('list')">
                                <i class="fas fa-list"></i> List View
                            </button>
                            <button class="view-btn" onclick="setView('grid')">
                                <i class="fas fa-th"></i> Grid View
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Fallback Streaming: Logged Cookies -->
                <div class="settings-section">
                    <h3>Fallback Streaming</h3>
                    <div class="settings-option">
                        <div class="settings-option-label">
                            <i class="fas fa-cookie-bite"></i>
                            Logged Cookies (Paste & Submit)
                        </div>
                        <div class="settings-option-description">
                            Use this only if normal streaming fails or YouTube asks to login. Paste your logged cookies
                            below and submit to save them for fallback streaming. Contents will be written verbatim to a
                            secure file and never logged.
                        </div>
                        <textarea id="loggedCookiesInput" placeholder="Paste logged cookies here..."
                            style="width: 100%; min-height: 120px; margin-top: 10px; border-radius: 8px; padding: 10px;"></textarea>
                        <div style="display: flex; gap: 10px; margin-top: 12px;">
                            <button class="btn btn-primary" onclick="submitLoggedCookies()" style="flex: 1;">
                                <i class="fas fa-save"></i> Save Logged Cookies
                            </button>
                            <button class="btn" onclick="document.getElementById('loggedCookiesInput').value='';"
                                style="flex: 1;">
                                <i class="fas fa-eraser"></i> Clear
                            </button>
                        </div>
                        <p id="loggedCookiesStatus" style="margin-top: 8px; font-size: 0.9rem;"></p>
                    </div>
                </div>

                <!-- Video Settings -->
                <div class="settings-section">
                    <h3>Video Settings</h3>
                    <div class="settings-option">
                        <div class="settings-option-label">
                            <i class="fas fa-play-circle"></i>
                            Default Playback Mode
                        </div>
                        <div class="settings-option-description">
                            Choose whether to start in audio-only or video mode
                        </div>
                        <div class="view-toggle" style="margin-top: 10px;">
                            <button class="view-btn" id="settingsAudioModeBtn" onclick="setDefaultVideoMode(false)">
                                <i class="fas fa-music"></i> Audio Only
                            </button>
                            <button class="view-btn" id="settingsVideoModeBtn" onclick="setDefaultVideoMode(true)">
                                <i class="fas fa-video"></i> Video Mode
                            </button>
                        </div>
                    </div>
                    <div class="settings-option" style="margin-top: 15px;">
                        <div class="settings-option-label">
                            <i class="fas fa-sliders-h"></i>
                            Default Video Quality
                        </div>
                        <div class="settings-option-description">
                            Choose the default video quality (480p recommended for balance)
                        </div>
                        <select id="settingsQualitySelect" onchange="setDefaultQuality(this.value)"
                            style="width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2);">
                            <option value="360p">360p (Low)</option>
                            <option value="480p" selected>480p (Recommended)</option>
                            <option value="720p">720p (HD)</option>
                            <option value="1080p">1080p (Full HD)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>

</html>